<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>QuietControl</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial;
  direction: rtl;
  padding: 30px;
  background: #f7f7f7;
}
.container {
  max-width: 600px;
  margin: auto;
  background: white;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
textarea {
  width: 100%;
  height: 150px;
  margin-top: 10px;
}
button {
  padding: 10px 20px;
  margin-top: 10px;
  cursor: pointer;
}
#app { display: none; }
</style>
</head>

<body>

<div class="container">

<h2>QuietControl</h2>

<div id="login">
  <p>הכניסי מייל לקבלת קוד כניסה:</p>
  <input type="email" id="email" placeholder="your@email.com">
  <button onclick="sendLogin()">שלח קוד</button>
</div>

<div id="app">
  <p>מחוברת בהצלחה</p>
  <textarea id="stateBox" placeholder="כאן יישמר המידע שלך..."></textarea>
  <button onclick="saveState()">שמור</button>
  <button onclick="logout()">התנתק</button>
</div>

</div>

<script>

const SUPABASE_URL = "https://xbvxjyiatcpvdcmakxwz.supabase.co"
const SUPABASE_KEY = "sb_publishable_k8Drp1fN_c3509HkTyAKKw_ETsiUgZS"

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

async function sendLogin() {
  const email = document.getElementById("email").value
  const { error } = await supabase.auth.signInWithOtp({ email })
  if (error) {
    alert(error.message)
  } else {
    alert("נשלח קוד למייל שלך")
  }
}

async function checkSession() {
  const { data: { session } } = await supabase.auth.getSession()
  if (session) {
    document.getElementById("login").style.display = "none"
    document.getElementById("app").style.display = "block"
    loadState(session.user.id)
  }
}

async function loadState(userId) {
  const { data } = await supabase
    .from("qc_states")
    .select("*")
    .eq("user_id", userId)
    .maybeSingle()

  if (data && data.state_json) {
    document.getElementById("stateBox").value = data.state_json
  }
}

async function saveState() {
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) return

  const userId = session.user.id
  const value = document.getElementById("stateBox").value

  const { data } = await supabase
    .from("qc_states")
    .select("*")
    .eq("user_id", userId)
    .maybeSingle()

  if (data) {
    await supabase
      .from("qc_states")
      .update({ state_json: value })
      .eq("user_id", userId)
  } else {
    await supabase
      .from("qc_states")
      .insert({ user_id: userId, state_json: value })
  }

  alert("נשמר בהצלחה")
}

async function logout() {
  await supabase.auth.signOut()
  location.reload()
}

checkSession()

</script>

</body>
</html>
