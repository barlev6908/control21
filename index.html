<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuietControl Cloud (Per User)</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --card:#ffffff;
      --ink:#2a2a2a;
      --muted:#6a6a6a;
      --line:#e5e7f2;

      --radius:16px;

      --fontBody: Arial, sans-serif;
      --fontHead: "Poppins","Heebo","Rubik","Assistant", Arial, sans-serif;

      --ok:#2e9b63;
      --bad:#c0392b;

      --theadBg:#cfeff1;
      --theadInk:#0b5f66;

      --turqBorder:#7fdede;
      --accentLogin:#bfeeee;

      /* pastel urgency row colors */
      --uTodayBg: #f1fbf7;
      --uWeekBg:  #fff7ef;
      --uMonthBg: #f1f6ff;
    }

    body{
      margin:0;
      font-family:var(--fontBody);
      background:linear-gradient(180deg,#f3f5ff,#fafbff);
      color:var(--ink);
      min-height:100vh;
    }

    /* LOGIN */
    #loginWrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .loginCard{
      width:min(560px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,0.06);
      padding:18px;
    }
    .loginBrand{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 6px;
    }
    .loginTitle{
      margin:0;
      font-family:var(--fontHead);
      font-size:22px;
      font-weight:800;
      letter-spacing:0.2px;
    }
    .loginSub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      font-family:var(--fontHead);
    }
    .pill{
      background:rgba(191,238,238,0.35);
      border:1px solid rgba(191,238,238,0.9);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:#0f5555;
      white-space:nowrap;
      font-family:var(--fontHead);
      font-weight:700;
    }
    .loginLabel{
      display:block;
      margin-top:14px;
      margin-bottom:6px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      font-family:var(--fontHead);
    }
    #email, #pw, #pw2{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:14px;
      outline:none;
      box-sizing:border-box;
      font-family:var(--fontBody);
      background:#fff;
    }
    #email:focus, #pw:focus, #pw2:focus{
      border-color:rgba(127,222,222,0.9);
      box-shadow:0 0 0 3px rgba(127,222,222,0.25);
    }
    .loginRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .loginBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
      font-weight:800;
      font-family:var(--fontHead);
    }
    .loginPrimary{
      background:var(--accentLogin);
      border-color:rgba(127,222,222,0.9);
      color:#0f5555;
    }
    .loginGhost{ color:var(--muted); }
    #err{
      margin-top:10px;
      color:var(--bad);
      font-size:12.5px;
      display:none;
      font-weight:800;
      font-family:var(--fontHead);
      white-space:pre-wrap;
      line-height:1.35;
    }
    .loginHint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* APP */
    #appWrap{ display:none; min-height:100vh; }

    .topbar{
      position:sticky;
      top:0;
      z-index:9999;
      background:rgba(255,255,255,0.92);
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .topbarLeft{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .topbar .mini{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      font-family:var(--fontHead);
    }
    .logout{
      border:1px solid rgba(192,57,43,0.35);
      background:rgba(192,57,43,0.10);
      color:var(--bad);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
      font-family:var(--fontHead);
    }
    .saveBtn{
      border:1px solid rgba(46,155,99,0.35);
      background:rgba(46,155,99,0.12);
      color:var(--ok);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
      font-family:var(--fontHead);
    }
    #saveState{
      display:none;
      font-size:12px;
      color:var(--ok);
      font-weight:900;
      font-family:var(--fontHead);
    }

    .wrap{max-width:1260px;margin:8px auto 14px;padding:0 12px;}
    .grid{display:grid;grid-template-columns: 1fr 320px;gap:10px;}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:10px;
      margin-bottom:10px;
    }

    h1,h2{font-family:var(--fontHead);}
    h2{margin:0 0 6px;font-size:16.5px;line-height:1.1;}
    .small{font-size:11px;color:var(--muted);line-height:1.25;}

    .monthTitle{
      margin:6px 0 10px;
      font-family:var(--fontHead);
      font-size:20px;
      font-weight:900;
      color:#0f3f33;
      letter-spacing:0.2px;
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .monthTitle .year{
      font-size:12px;
      font-weight:800;
      color:rgba(15,63,51,0.75);
    }

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
    }
    th,td{border:1px solid #e3e9ee;padding:6px;font-size:12.5px;vertical-align:top;}
    th{
      font-family:var(--fontHead);
      font-weight:700;
      background:var(--theadBg);
      color:var(--theadInk);
      font-size:14px;
    }

    input,select,textarea{
      width:100%;
      padding:5px 6px;
      border:1px solid var(--line);
      border-radius:10px;
      font-size:12px;
      font-family:inherit;
      background:#fff;
      box-sizing:border-box;
    }

    button{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:5px 7px;
      cursor:pointer;
      font-size:11px;
      line-height:1.1;
      font-family:var(--fontHead);
    }
    .primary{background:#f1f2ff;font-weight:700;}

    .btnDanger{
      border-color: rgba(192,57,43,0.45);
      background: rgba(192,57,43,0.12);
      color: var(--bad);
      font-weight:700;
    }
    .btnOk{
      border-color: rgba(46,155,99,0.45);
      background: rgba(46,155,99,0.12);
      color: var(--ok);
      font-weight:900;
    }

    .hr{height:1px;background:var(--line);margin:8px 0;}

    .top tr.uTodayRow td{ background: var(--uTodayBg) !important; }
    .top tr.uWeekRow  td{ background: var(--uWeekBg)  !important; }
    .top tr.uMonthRow td{ background: var(--uMonthBg) !important; }

    /* Contenteditable task box */
    .top .taskText{
      width:100%;
      min-height:36px;
      font-size:12px;
      padding:5px 6px;
      overflow:auto;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      box-sizing:border-box;
      font-family:inherit;
      line-height:1.25;
      white-space:pre-wrap;
      word-break:break-word;
      outline:none;
      cursor:text !important;
    }
    .top .taskText:focus{
      border-color:rgba(127,222,222,0.9);
      box-shadow:0 0 0 3px rgba(127,222,222,0.20);
    }
    .top .taskText[data-placeholder]:empty:before{
      content: attr(data-placeholder);
      color: rgba(106,106,106,0.75);
    }

    .brainActions{
      display:flex;
      gap:6px;
      flex-wrap:nowrap;
      justify-content:flex-start;
      align-items:center;
    }
    .brainActions .iconBtn{
      width: 30px;
      min-width: 30px;
      height: 28px;
      padding: 0;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      line-height: 1;
      background: transparent;
    }

    .btnStar{
      border: 1px solid rgba(212,175,55,0.45);
      background: rgba(212,175,55,0.10);
      color: rgba(120,120,120,0.9);
      font-weight: 900;
    }
    .btnStar.on{
      background: rgba(212,175,55,0.18);
      color: #d4af37;
      border-color: rgba(212,175,55,0.65);
    }

    .banner{
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--line);
      margin-bottom:10px;
      position:relative;
      height:86px;
      background:
        linear-gradient(90deg,
          rgba(155, 220, 190, 0.72),
          rgba(155, 220, 190, 0.40),
          rgba(155, 220, 190, 0.18)
        );
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      direction:ltr;
    }
    .bannerLeft{
      direction:ltr;
      flex: 1 1 auto;
      max-width: calc(100% - 260px);
      padding-left:12px;
    }
    .bannerText{
      direction:ltr;
      flex: 0 0 260px;
      max-width: 260px;
      margin-left:auto;
      padding-right:14px;
      text-align:right;
    }
    .bannerTitle{
      font-family:var(--fontHead);
      font-weight:700;
      font-size:22px;
      color:#0f3f33;
      letter-spacing:0.3px;
    }
    .bannerSub{
      margin-top:4px;
      font-family:var(--fontHead);
      font-weight:500;
      font-size:12.5px;
      color:rgba(15,63,51,0.88);
      letter-spacing:0.25px;
    }

    .weatherStrip{
      display:flex;
      gap:8px;
      align-items:stretch;
      justify-content:flex-start;
      flex-wrap:nowrap;
      overflow-x:auto;
      padding-bottom:4px;
      direction:rtl;
    }
    .weatherStrip::-webkit-scrollbar{ height:6px; }
    .weatherDay{
      width:64px;
      min-width:64px;
      padding:6px 6px 5px;
      border-radius:12px;
      background: linear-gradient(180deg, #ffffff 0%, #f3fbf8 100%);
      border:1px solid rgba(80,170,160,0.35);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:space-between;
      box-sizing:border-box;
      direction:rtl;
    }
    .weatherDay.today{
      background: linear-gradient(180deg, #fff7df 0%, #ffefc2 100%) !important;
      border-color: rgba(242,201,76,0.9) !important;
    }
    .weatherDay .wDayName{ font-weight: 900; font-size: 11px; line-height: 1.1; opacity: 0.9; }
    .weatherDay .wIcon{ width:22px !important; height:22px !important; display:block; margin:2px auto 2px; }
    .weatherDay .wTemps{ font-size: 11px; font-weight: 900; display:flex; gap:6px; align-items:baseline; }
    .weatherDay .wMin{ opacity:0.75; color:#64748b; }
    .weatherDay .wMax{ opacity:0.95; color:#0f766e; }
    .weatherLoading{ font-size: 12.5px; font-weight: 800; opacity: 0.7; padding: 6px 10px; }

    .daily-motivation{
      font-family: 'Poppins', Arial, sans-serif;
      font-size:26px;
      font-weight:900;
      color:#C9A24D;
      text-align:center;
      background:rgba(255,215,150,0.18);
      padding:12px 20px;
      border-radius:14px;
      max-width:820px;
      margin:0 auto;
      line-height:1.3;
      letter-spacing:0.5px;
      direction:rtl;
    }
    .motivationRow{ margin-top: 14px; width:100%; display:flex; justify-content:center; align-items:center; padding: 10px 12px 2px; }

    /* Weekly */
    .weekNav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .weekTitle{display:flex;flex-direction:column;align-items:center;min-width:180px;}
    .weekTitleMain{font-weight:700;}
    .weekTitleSub{font-size:12px;opacity:0.8;}
    .wBtn{padding:8px 10px;border:1px solid #cfd6e4;border-radius:10px;background:#fff;cursor:pointer;}
    .wDate{padding:7px 10px;border:1px solid #cfd6e4;border-radius:10px;}

    .week2{
      table-layout: fixed !important;
      width: 100% !important;
      border-collapse:collapse;
    }
    .week2 th, .week2 td{
      width: calc(100% / 7) !important;
      max-width: calc(100% / 7) !important;
      overflow: hidden !important;
      vertical-align: top;
      padding:2px;
      font-size:11.2px;
      text-align:center;
    }
    .week2 .dayHead{
      font-weight:800;
      font-family:var(--fontHead);
      background:var(--theadBg);
      color:var(--theadInk);
      font-size:12.8px;
      line-height:1.1;
    }
    .dayDate{
      display:block;
      font-size:11px;
      font-weight:700;
      color:rgba(19,75,75,0.78);
      margin-top:2px;
    }
    .week2 td{
      white-space: normal !important;
      overflow-wrap: break-word !important;
      word-break: break-word !important;
      padding:4px;
    }
    .week2 .taskCell{
      width: 100% !important;
      box-sizing: border-box !important;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      padding:6px 8px;
      min-height:64px;
      line-height:1.15;
      user-select:none;
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:6px;
      justify-content:space-between;
    }
    .week2 .taskCell.empty{
      background:#fcfcff;
      border-style:dashed;
      border-color:#dfe3f7;
      align-items:flex-start;
    }
    .week2 .taskCell.empty:hover{
      background:#f7f8ff;
      border-color:#cfd6ff;
    }
    .taskMain{display:flex;flex-direction:column;gap:2px;text-align:right;flex:1 1 auto;overflow:hidden;}
    .taskTopic{
      font-size:12.6px;
      font-weight:900;
      font-family:var(--fontHead);
      white-space:normal;
      word-break:break-word;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:3;
      overflow:hidden;
    }
    .statusBtn{
      padding:3px 8px;
      border-radius:999px;
      font-size:10.8px;
      white-space:nowrap;
      font-family:var(--fontHead);
      background:rgba(255,255,255,0.7);
      align-self:flex-start;
    }
    .popOk{
      border-color: rgba(46,155,99,0.45);
      background: rgba(46,155,99,0.12);
      color: var(--ok);
      font-weight:700;
    }
    .popBad{
      border-color: rgba(192,57,43,0.45);
      background: rgba(192,57,43,0.12);
      color: var(--bad);
      font-weight:700;
    }
    .popover{
      position:fixed;
      z-index:9999;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px;
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
      width:190px;
      font-family:var(--fontBody);
      direction:rtl;
    }
    .popTitle{
      font-family:var(--fontHead);
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    .popHint{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.25;}
    .popBtns{display:flex;gap:8px;}
    .popBtns button{flex:1;border-radius:999px;padding:6px 8px;font-size:11.5px;}

    @media(max-width:1000px){
      .grid{grid-template-columns:1fr;}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<!-- LOGIN -->
<div id="loginWrap">
  <div class="loginCard">
    <div class="loginBrand">
      <div>
        <h1 class="loginTitle">QuietControl</h1>
        <div class="loginSub">Calm order. Real control.</div>
      </div>
      <div class="pill" id="authModePill">×›× ×™×¡×”</div>
    </div>

    <label class="loginLabel" for="email">××™××™×™×œ</label>
    <input id="email" type="email" autocomplete="username" placeholder="name@example.com" />

    <label class="loginLabel" for="pw">×¡×™×¡××”</label>
    <input id="pw" type="password" autocomplete="current-password" placeholder="" />

    <label class="loginLabel" for="pw2" id="pw2Label" style="display:none;">××™×©×•×¨ ×¡×™×¡××”</label>
    <input id="pw2" type="password" autocomplete="new-password" placeholder="" style="display:none;" />

    <div class="loginRow">
      <button class="loginBtn loginPrimary" id="btnLogin" type="button">×”×™×›× ×¡×™</button>
      <button class="loginBtn loginGhost" id="btnToggleMode" type="button">××™×Ÿ ×œ×™ ××©×ª××© - ×”×¨×©××”</button>
      <button class="loginBtn loginGhost" id="btnClear" type="button">× ×§×”</button>
    </div>

    <div id="err">×©×’×™××”</div>

    <div class="loginHint">
      ×–×” ×¢×•×‘×“ ×›×›×”: ×œ×›×œ ××©×ª××© ×™×© ×©××™×¨×” ×‘×¢× ×Ÿ ××©×œ×•. ×›×©× ×›× ×¡×™× ×××•×ª×• ××©×ª××© ×××›×©×™×¨ ××—×¨, ×”× ×ª×•× ×™× ×™×•×¨×“×™× ××”×¢× ×Ÿ.
    </div>
  </div>
</div>

<!-- APP -->
<div id="appWrap">
  <div class="topbar">
    <div class="topbarLeft">
      <div class="mini">QuietControl Cloud (Per User)</div>
      <div class="mini" id="whoami" style="font-weight:900;"></div>
      <button class="saveBtn" id="btnSaveNow" type="button">×©××•×¨</button>
      <div id="saveState">× ×©××¨</div>
    </div>
    <button class="logout" id="btnLogout" type="button">×”×ª× ×ª×§×•×ª</button>
  </div>

  <div class="wrap">
    <div class="grid">
      <div>
        <div class="card">
          <div class="banner">
            <div class="bannerLeft">
              <div class="weatherStrip" id="weatherStrip"><div class="weatherLoading">×˜×•×¢×Ÿ ××–×’ ××•×•×™×¨...</div></div>
            </div>
            <div class="bannerText">
              <div>
                <div class="bannerTitle">QuietControl</div>
                <div class="bannerSub">Calm order. Real control</div>
              </div>
            </div>
          </div>

          <div class="motivationRow"><div class="daily-motivation" id="dailyMotivation">MAKE IT DONE</div></div>

          <div class="monthTitle" id="topMonthTitle">
            <span id="topMonthName">×—×•×“×©</span>
            <span class="year" id="topMonthYear"></span>
          </div>

          <!-- WORK -->
          <div style="margin-top:8px;">
            <table class="top workTable">
              <thead>
                <tr>
                  <th style="width:44%;">××©×™××•×ª ×‘×¢×‘×•×“×”</th>
                  <th style="width:12%;">×“×—×™×¤×•×ª</th>
                  <th style="width:14%;">×‘×—×™×¨×ª ×™×•×</th>
                  <th style="width:160px;">×©×¢×”</th>
                  <th style="width:220px;">×¤×¢×•×œ×•×ª</th>
                </tr>
              </thead>
              <tbody id="brainBodyWork"></tbody>
            </table>
            <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
              <button id="addBrainWork" class="primary" type="button">×”×•×¡×£ ×©×•×¨×”</button>
              <div class="small">×”×©×•×¨×•×ª ××¡×•×“×¨×•×ª ×œ×¤×™ ×“×—×™×¤×•×ª (×”×™×•×, ×”×©×‘×•×¢, ×”×—×•×“×©).</div>
            </div>
          </div>

          <div class="hr"></div>

          <!-- PERSONAL -->
          <div style="margin-top:8px;">
            <table class="top personalTable">
              <thead>
                <tr>
                  <th style="width:44%;">××©×™××•×ª ××™×©×™×•×ª</th>
                  <th style="width:12%;">×“×—×™×¤×•×ª</th>
                  <th style="width:14%;">×‘×—×™×¨×ª ×™×•×</th>
                  <th style="width:160px;">×©×¢×”</th>
                  <th style="width:220px;">×¤×¢×•×œ×•×ª</th>
                </tr>
              </thead>
              <tbody id="brainBodyPersonal"></tbody>
            </table>
            <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
              <button id="addBrainPersonal" class="primary" type="button">×”×•×¡×£ ×©×•×¨×”</button>
              <div class="small">×¨×©×™××” × ×¤×¨×“×ª ××”×¢×‘×•×“×”.</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="weekNav">
            <button class="wBtn" id="prevWeek" type="button">â–¶</button>
            <button class="wBtn" id="btnWeekToday" type="button">×”×™×•×</button>
            <div class="weekTitle">
              <div class="weekTitleMain">×ª×›× ×•×Ÿ ×©×‘×•×¢×™</div>
              <div class="weekTitleSub" id="weekRangeLabel"></div>
            </div>
            <button class="wBtn" id="nextWeek" type="button">â—€</button>
            <input class="wDate" id="weekPick" type="date" />
          </div>

          <div style="margin-top:8px;">
            <table class="week2">
              <thead><tr id="weekHeadRow"></tr></thead>
              <tbody id="weekBody"></tbody>
            </table>
          </div>

          <div class="hr"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="addWeekRow" class="primary" type="button">×”×•×¡×£ ×©×•×¨×”</button>
          </div>
        </div>
      </div>

      <!-- SIDE -->
      <div class="side">
        <div class="card">
          <h2>×”×¢×¨×•×ª</h2>
          <div style="margin-top:8px;">
            <textarea id="notesText" placeholder="×›×ª×‘×™ ×›××Ÿ ×”×¢×¨×•×ª..."></textarea>
          </div>
        </div>

        <div class="card">
          <h2>××™×“×¢</h2>
          <div class="small" style="white-space:pre-wrap;" id="infoBox"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* =========================
   Supabase setup
   =========================
  ×‘×˜×‘×œ×ª SQL (×—×“ ×¤×¢××™) ×‘-Supabase:

  create table if not exists public.qc_states (
    user_id uuid primary key,
    state_json jsonb not null,
    updated_at timestamptz not null default now()
  );

  alter table public.qc_states enable row level security;

  create policy "Users can read own state"
  on public.qc_states for select
  using (auth.uid() = user_id);

  create policy "Users can upsert own state"
  on public.qc_states for insert
  with check (auth.uid() = user_id);

  create policy "Users can update own state"
  on public.qc_states for update
  using (auth.uid() = user_id);
*/

const SUPABASE_URL = "https://xbvxjyiatcpvdcmakxwz.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_k8Drp1fN_c3509HkTyAKKw_ETsiUgZS";

let sb = null;
let _qcUser = null;

function $(id){ return document.getElementById(id); }

function showApp(){
  $("loginWrap").style.display = "none";
  $("appWrap").style.display = "block";
  $("err").style.display = "none";
}
function showLogin(){
  $("appWrap").style.display = "none";
  $("loginWrap").style.display = "flex";
}

function setErr(msg){
  const el = $("err");
  el.textContent = msg || "×©×’×™××”";
  el.style.display = "block";
}
function setInfo(msg){
  const el = $("infoBox");
  if(el) el.textContent = msg || "";
}
function setWho(email){
  const el = $("whoami");
  if(el) el.textContent = email ? ("××—×•×‘×¨/×ª: " + email) : "";
}

function storageKey(){
  const uid = (_qcUser && _qcUser.id) ? _qcUser.id : "anon";
  return "quietcontrol_cloud_state::" + uid;
}

/* =========================
   App data
   ========================= */
const URGENCY = ["×”×™×•×","×”×©×‘×•×¢","×”×—×•×“×©"];
const DAYS = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
const HEB_MONTHS = ["×™× ×•××¨","×¤×‘×¨×•××¨","××¨×¥","××¤×¨×™×œ","×××™","×™×•× ×™","×™×•×œ×™","××•×’×•×¡×˜","×¡×¤×˜××‘×¨","××•×§×˜×•×‘×¨","× ×•×‘××‘×¨","×“×¦××‘×¨"];
const MIN_TOP_ROWS = 3;

function uid(){ return "t_" + Math.random().toString(36).slice(2) + Date.now().toString(36); }
function pad2(n){ return String(n).padStart(2,"0"); }
function isoFromDate(d){
  const y=d.getFullYear(), m=pad2(d.getMonth()+1), da=pad2(d.getDate());
  return `${y}-${m}-${da}`;
}
function dateFromIso(iso){
  const [y,m,d]=iso.split("-").map(Number);
  return new Date(y, (m||1)-1, d||1);
}
function addDaysIso(iso, days){
  const d = dateFromIso(iso);
  d.setDate(d.getDate()+days);
  return isoFromDate(d);
}
function weekStartSundayIso(anyIso){
  const d = dateFromIso(anyIso);
  const jsDay = d.getDay();
  d.setDate(d.getDate() - jsDay);
  return isoFromDate(d);
}
function todayIso(){ return isoFromDate(new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Jerusalem" }))); }
function formatDDMM(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}`; }

function makeDefaultBrainRows(){
  return Array.from({length:3},(_,idx)=>({
    id:uid(), t:"", u:"×”×©×‘×•×¢", day:"", time:"", mdate:"",
    important:false, order: idx
  }));
}
function def(){
  return{
    notes:"",
    brainWork: makeDefaultBrainRows(),
    brainPersonal: makeDefaultBrainRows(),
    visWork: MIN_TOP_ROWS,
    visPersonal: MIN_TOP_ROWS,
    weekRowCount:3,
    currentWeekStart: weekStartSundayIso(todayIso()),
    weeksByStart: {},
    week: DAYS.map(d=>({ d, rows:[] })),
  };
}

let s = null;
let dirty = false;
let cloudSaveTimer = null;

function flashSaved(){
  const el = $("saveState");
  if(!el) return;
  el.style.display = "block";
  setTimeout(()=>{ el.style.display = "none"; }, 1200);
}

function ensureWeekMatrix(){
  s.week = DAYS.map((d,di)=>{
    const existing = (s.week && s.week[di] && s.week[di].rows) ? s.week[di].rows : [];
    const rows = [];
    for(let ri=0; ri<s.weekRowCount; ri++){
      const cell = existing[ri] || {text:"", status:"none"};
      rows.push({ text: String(cell.text||""), status: ["none","done","notdone"].includes(cell.status) ? cell.status : "none" });
    }
    return {d, rows};
  });
}

function ensureWeekStore(){
  if(!s.weeksByStart) s.weeksByStart = {};
  if(!s.currentWeekStart) s.currentWeekStart = weekStartSundayIso(todayIso());
  if(s.week && !s.weeksByStart[s.currentWeekStart]){
    s.weeksByStart[s.currentWeekStart] = { rowCount: s.weekRowCount || 3, week: s.week };
  }
}
function loadWeek(startIso){
  ensureWeekStore();
  if(!s.weeksByStart[startIso]){
    const rowCount = s.weekRowCount || 3;
    const week = DAYS.map((d)=>({d, rows:Array.from({length:rowCount}, ()=>({text:"",status:"none"}))}));
    s.weeksByStart[startIso] = { rowCount, week };
  }
  const pack = s.weeksByStart[startIso];
  s.weekRowCount = pack.rowCount || 3;
  s.week = pack.week;
  ensureWeekMatrix();
}
function saveWeek(startIso){
  ensureWeekStore();
  s.weeksByStart[startIso] = { rowCount: s.weekRowCount || 3, week: s.week };
}
function setCurrentWeek(startIso){
  ensureWeekStore();
  saveWeek(s.currentWeekStart);
  s.currentWeekStart = startIso;
  loadWeek(startIso);
  markDirty();
}

function normalize(){
  try{
    s = JSON.parse(localStorage.getItem(storageKey()) || "null");
  }catch(e){ s = null; }
  if(!s) s = def();

  if(typeof s.notes !== "string") s.notes = "";
  if(!Array.isArray(s.brainWork)) s.brainWork = makeDefaultBrainRows();
  if(!Array.isArray(s.brainPersonal)) s.brainPersonal = makeDefaultBrainRows();

  if(!Number.isInteger(s.visWork) || s.visWork < MIN_TOP_ROWS) s.visWork = MIN_TOP_ROWS;
  if(!Number.isInteger(s.visPersonal) || s.visPersonal < MIN_TOP_ROWS) s.visPersonal = MIN_TOP_ROWS;

  if(!Number.isInteger(s.weekRowCount) || s.weekRowCount < 3) s.weekRowCount = 3;

  ensureWeekStore();
  loadWeek(s.currentWeekStart);

  localStorage.setItem(storageKey(), JSON.stringify(s));
}

function markDirty(){
  dirty = true;
  scheduleCloudSave();
}

async function cloudSaveNow(){
  if(!sb || !_qcUser) return;
  let payload = null;
  try{ payload = JSON.parse(localStorage.getItem(storageKey()) || "null"); }catch(e){ payload = null; }
  if(!payload) return;

  const { error } = await sb.from("qc_states").upsert({
    user_id: _qcUser.id,
    state_json: payload,
    updated_at: new Date().toISOString()
  });
  if(error){
    setInfo("×©×’×™××ª ×©××™×¨×” ×œ×¢× ×Ÿ:\n" + (error.message || String(error)));
  }
}

function scheduleCloudSave(){
  if(!sb || !_qcUser) return;
  clearTimeout(cloudSaveTimer);
  cloudSaveTimer = setTimeout(()=>{ cloudSaveNow(); }, 650);
}

function saveLocal(showToast=false){
  try{
    localStorage.setItem(storageKey(), JSON.stringify(s));
    dirty = false;
    if(showToast) flashSaved();
  }catch(e){}
}

/* =========================
   Render helpers
   ========================= */
function updateTopMonthTitle(){
  const d = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Jerusalem" }));
  $("topMonthName").textContent = HEB_MONTHS[d.getMonth()] || "×—×•×“×©";
  $("topMonthYear").textContent = String(d.getFullYear());
}
function urgencyRank(u){
  if(u === "×”×™×•×") return 0;
  if(u === "×”×©×‘×•×¢") return 1;
  return 2;
}
function brainSorted(arr){
  return [...arr].sort((a,b)=>{
    const ra = urgencyRank(a.u);
    const rb = urgencyRank(b.u);
    if(ra !== rb) return ra - rb;
    return (a.order ?? 0) - (b.order ?? 0);
  });
}
function rowClassByUrgency(u){
  if(u==="×”×™×•×") return "uTodayRow";
  if(u==="×”×©×‘×•×¢") return "uWeekRow";
  return "uMonthRow";
}
function dayLabelWithDate(dayName){
  const di = DAYS.indexOf(dayName);
  if(di < 0) return dayName;
  const startIso = s.currentWeekStart || weekStartSundayIso(todayIso());
  const d = dateFromIso(addDaysIso(startIso, di));
  return `${dayName} (${formatDDMM(d)})`;
}
function buildDayOptions(selected){
  const none = `<option value="">(×œ×œ×)</option>`;
  const opts = DAYS.map(d=>{
    const label = dayLabelWithDate(d);
    return `<option value="${d}" ${d===selected?"selected":""}>${label}</option>`;
  }).join("");
  return none + opts;
}
function sanitizeText(x){ return String(x ?? "").replace(/[<>]/g, ""); }

/* =========================
   Render top tables
   ========================= */
function renderBrainTable(kind){
  updateTopMonthTitle();

  const isWork = kind === "work";
  const arr = isWork ? s.brainWork : s.brainPersonal;
  const body = isWork ? $("brainBodyWork") : $("brainBodyPersonal");
  body.innerHTML = "";

  const sortedAll = brainSorted(arr);
  const visible = isWork ? s.visWork : s.visPersonal;
  const sorted = sortedAll.slice(0, Math.max(MIN_TOP_ROWS, visible));

  sorted.forEach((r)=>{
    const tr = document.createElement("tr");
    tr.className = rowClassByUrgency(r.u);

    const dayOptions = buildDayOptions(r.day);

    tr.innerHTML = `
      <td><div class="taskText" contenteditable="true" spellcheck="false" data-placeholder="×¨×¢×™×•× ×•×ª / ××©×™××•×ª..."></div></td>
      <td>
        <select class="urgSel">
          ${URGENCY.map(o=>`<option ${o===r.u?"selected":""}>${o}</option>`).join("")}
        </select>
      </td>
      <td class="whenCell"></td>
      <td>
        <input class="timeInp" type="time" step="900" value="${sanitizeText(r.time||"")}" />
      </td>
      <td>
        <div class="brainActions">
          <button class="btnStar iconBtn" type="button" title="×—×©×•×‘">â˜†</button>
          <button class="btnOk iconBtn btnDone" type="button" title="×˜×•×¤×œ">âœ“</button>
          <button class="btnDanger iconBtn btnDel" type="button" title="××—×§">ğŸ—‘</button>
        </div>
      </td>
    `;

    const editor = tr.querySelector(".taskText");
    editor.textContent = String(r.t || "");

    const whenCell = tr.querySelector(".whenCell");
    function renderWhen(){
      if(r.u === "×”×™×•×"){
        const today = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Jerusalem" }));
        const dname = DAYS[today.getDay()];
        whenCell.innerHTML = `<div style="font-weight:900;font-family:var(--fontHead);">${dayLabelWithDate(dname)}</div>`;
        r.day = "";
        r.mdate = "";
      } else if(r.u === "×”×©×‘×•×¢"){
        whenCell.innerHTML = `<select class="daySel">${dayOptions}</select>`;
        r.mdate = "";
        const sel = whenCell.querySelector(".daySel");
        sel.onchange = (e)=>{
          r.day = e.target.value || "";
          markDirty(); saveLocal(false);
        };
      } else {
        whenCell.innerHTML = `<input class="dateInp" type="date" value="${sanitizeText(r.mdate||"")}" />`;
        r.day = "";
        const di = whenCell.querySelector(".dateInp");
        di.oninput = (e)=>{
          r.mdate = (e.target.value || "").trim();
          markDirty(); saveLocal(false);
        };
      }
    }
    renderWhen();

    const urgSel = tr.querySelector(".urgSel");
    urgSel.onchange = (e)=>{
      r.u = e.target.value;
      renderWhen();
      markDirty(); saveLocal(false);
      renderBrainTable(kind);
    };

    const timeInp = tr.querySelector(".timeInp");
    timeInp.oninput = (e)=>{
      r.time = (e.target.value || "").trim();
      markDirty(); saveLocal(false);
    };

    let debounce = null;
    editor.addEventListener("input", ()=>{
      clearTimeout(debounce);
      debounce = setTimeout(()=>{
        r.t = (editor.innerText || "").trim();
        markDirty(); saveLocal(false);
      }, 220);
    });
    editor.addEventListener("blur", ()=>{
      r.t = (editor.innerText || "").trim();
      markDirty(); saveLocal(false);
    });

    const star = tr.querySelector(".btnStar");
    function refreshStar(){
      if(r.important){
        star.classList.add("on");
        star.textContent = "â˜…";
      }else{
        star.classList.remove("on");
        star.textContent = "â˜†";
      }
    }
    refreshStar();
    star.onclick = ()=>{
      r.important = !r.important;
      refreshStar();
      markDirty(); saveLocal(false);
    };

    tr.querySelector(".btnDone").onclick = ()=>{
      if(!String(r.t||"").trim()) return alert("××™×Ÿ ××©×™××” ×œ×¡××Ÿ");
      const idx = arr.findIndex(x=>x.id===r.id);
      if(idx >= 0) arr.splice(idx, 1);
      markDirty(); saveLocal(false);
      renderBrainTable(kind);
      flashSaved();
    };

    tr.querySelector(".btnDel").onclick = ()=>{
      const idx = arr.findIndex(x=>x.id===r.id);
      if(idx >= 0) arr.splice(idx, 1);
      markDirty(); saveLocal(false);
      renderBrainTable(kind);
    };

    body.appendChild(tr);
  });
}

function renderBrain(){
  renderBrainTable("work");
  renderBrainTable("personal");
}

/* =========================
   Weekly render
   ========================= */
function renderWeekHeader(){
  const startIso = s.currentWeekStart || weekStartSundayIso(todayIso());
  $("weekRangeLabel").textContent = (()=>{
    const endIso = addDaysIso(startIso, 6);
    return `${formatDDMM(dateFromIso(startIso))}-${formatDDMM(dateFromIso(endIso))}`;
  })();
  $("weekPick").value = startIso;

  const tr = $("weekHeadRow");
  tr.innerHTML = "";
  for(let di=0; di<7; di++){
    const th = document.createElement("th");
    th.className="dayHead";
    const name = DAYS[di];
    const d = dateFromIso(addDaysIso(startIso, di));
    th.innerHTML = `${name}<span class="dayDate">${formatDDMM(d)}</span>`;
    tr.appendChild(th);
  }
}
function getCell(di,ri){ return s.week[di].rows[ri]; }

let pop = null;
function closePopover(){ if(pop){ pop.remove(); pop=null; } }
function openStatusPopover(x,y,di,ri){
  closePopover();
  pop = document.createElement("div");
  pop.className="popover";
  pop.style.left = Math.max(10, x - 180) + "px";
  pop.style.top  = Math.max(10, y + 10) + "px";
  pop.innerHTML = `
    <div class="popTitle">×¡×˜×˜×•×¡ ××©×™××”</div>
    <div class="popBtns">
      <button class="popOk" type="button">×˜×•×¤×œ</button>
      <button class="popBad" type="button">×œ× ×˜×•×¤×œ</button>
    </div>
    <div class="popHint">×œ×—×¦×™ ××—×•×¥ ×œ×—×œ×•×Ÿ ×œ×¡×’×™×¨×”</div>
  `;
  document.body.appendChild(pop);

  pop.querySelector(".popOk").onclick = ()=>{
    const c = getCell(di,ri);
    c.text = "";
    c.status = "none";
    markDirty(); saveLocal(false);
    renderWeek();
    closePopover();
  };
  pop.querySelector(".popBad").onclick = ()=>{
    const c = getCell(di,ri);
    c.status = "notdone";
    markDirty(); saveLocal(false);
    renderWeek();
    closePopover();
  };
}
document.addEventListener("click", (e)=>{
  if(pop && !pop.contains(e.target)) closePopover();
});

function renderWeek(){
  renderWeekHeader();
  ensureWeekMatrix();

  const body = $("weekBody");
  body.innerHTML = "";

  for(let ri=0; ri<s.weekRowCount; ri++){
    const tr = document.createElement("tr");

    for(let di=0; di<7; di++){
      const td = document.createElement("td");
      const cell = getCell(di,ri);

      const div = document.createElement("div");
      div.className = "taskCell";
      const txt = (cell.text || "").trim();

      if(!txt){
        div.classList.add("empty");
      } else {
        const main = document.createElement("div");
        main.className = "taskMain";
        const topic = document.createElement("div");
        topic.className = "taskTopic";
        topic.textContent = txt;
        main.appendChild(topic);
        div.appendChild(main);

        const btn = document.createElement("button");
        btn.className = "statusBtn";
        btn.textContent = (cell.status === "notdone") ? "×œ× ×˜×•×¤×œ" : "×¡×˜×˜×•×¡";
        if(cell.status === "notdone") btn.classList.add("popBad");

        btn.onclick = (e)=>{
          e.stopPropagation();
          openStatusPopover(e.clientX, e.clientY, di, ri);
        };
        div.appendChild(btn);
      }

      div.onclick = ()=>{
        const v = prompt(`××©×™××” ×œ×™×•× ${DAYS[di]}:`, txt || "");
        if(v === null) return;
        const val = String(v).trim();
        if(!val){
          cell.text = "";
          cell.status = "none";
        } else {
          cell.text = val;
          cell.status = "none";
        }
        markDirty(); saveLocal(false);
        renderWeek();
      };

      td.appendChild(div);
      tr.appendChild(td);
    }

    body.appendChild(tr);
  }
}

/* =========================
   Auth
   ========================= */
let authMode = "login";

function setAuthMode(mode){
  authMode = (mode === "signup") ? "signup" : "login";
  $("authModePill").textContent = (authMode === "login") ? "×›× ×™×¡×”" : "×”×¨×©××”";
  $("btnLogin").textContent = (authMode === "login") ? "×”×™×›× ×¡×™" : "×”×™×¨×©××™";
  $("btnToggleMode").textContent = (authMode === "login") ? "××™×Ÿ ×œ×™ ××©×ª××© - ×”×¨×©××”" : "×™×© ×œ×™ ××©×ª××© - ×›× ×™×¡×”";
  const showPw2 = (authMode === "signup");
  $("pw2").style.display = showPw2 ? "block" : "none";
  $("pw2Label").style.display = showPw2 ? "block" : "none";
  $("err").style.display = "none";
}

async function cloudLoadToLocal(){
  if(!sb || !_qcUser) return;

  const { data, error } = await sb
    .from("qc_states")
    .select("state_json")
    .eq("user_id", _qcUser.id)
    .maybeSingle();

  if(error){
    setInfo("×©×’×™××ª ×˜×¢×™× ×” ××”×¢× ×Ÿ:\n" + (error.message || String(error)));
    return;
  }

  if(data && data.state_json){
    try{
      localStorage.setItem(storageKey(), JSON.stringify(data.state_json));
    }catch(e){}
  } else {
    const initial = def();
    try{ localStorage.setItem(storageKey(), JSON.stringify(initial)); }catch(e){}
    await cloudSaveNow();
  }
}

async function doAuth(){
  const email = String($("email").value || "").trim();
  const pw = String($("pw").value || "").trim();
  const pw2 = String($("pw2").value || "").trim();

  if(!email || !email.includes("@")){ setErr("× × ×œ×”×–×™×Ÿ ××™××™×™×œ ×ª×§×™×Ÿ"); return; }
  if(pw.length < 6){ setErr("×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 6 ×ª×•×•×™×"); return; }
  if(authMode === "signup" && pw !== pw2){ setErr("×”×¡×™×¡×××•×ª ×œ× ×ª×•×××•×ª"); return; }

  try{
    if(authMode === "login"){
      const { error } = await sb.auth.signInWithPassword({ email, password: pw });
      if(error) throw error;
    } else {
      const redirectTo = location.origin + location.pathname;
      const { error } = await sb.auth.signUp({ email, password: pw, options: { emailRedirectTo: redirectTo } });
      if(error) throw error;
      setErr("× ×¨×©××ª ×‘×”×¦×œ×—×”. ×× × ×“×¨×© ××™××•×ª ××™×™×œ, ×‘×“×§×™ ××ª ×ª×™×‘×ª ×”×“×•××¨ ×•××– ×”×ª×—×‘×¨×™.");
      setAuthMode("login");
    }
  }catch(e){
    setErr((e && e.message) ? e.message : "×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª");
  }
}

async function doLogout(){
  try{ await sb.auth.signOut(); }catch(e){}
  _qcUser = null;
  setWho("");
  setInfo("");
  showLogin();
}

function bindAuthUi(){
  $("btnLogin").addEventListener("click", ()=>doAuth());
  $("btnToggleMode").addEventListener("click", ()=>{
    setAuthMode(authMode === "login" ? "signup" : "login");
  });
  $("btnClear").addEventListener("click", ()=>{
    $("email").value = "";
    $("pw").value = "";
    $("pw2").value = "";
    $("err").style.display = "none";
    $("email").focus();
  });
  ["email","pw","pw2"].forEach(id=>{
    $(id).addEventListener("keydown", (e)=>{ if(e.key === "Enter") doAuth(); });
  });
  $("btnLogout").addEventListener("click", ()=>doLogout());
}

async function onSignedIn(user){
  _qcUser = user;
  setWho(user.email || "");
  showApp();

  await cloudLoadToLocal();
  normalize();

  $("notesText").value = s.notes;
  $("notesText").oninput = (e)=>{
    s.notes = e.target.value;
    markDirty(); saveLocal(false);
  };

  $("btnSaveNow").onclick = async ()=>{
    saveLocal(true);
    await cloudSaveNow();
  };

  $("addBrainWork").onclick = ()=>{
    s.visWork = Math.max(MIN_TOP_ROWS, (s.visWork||MIN_TOP_ROWS) + 1);
    const maxOrder = Math.max(0, ...s.brainWork.map(x=>x.order??0));
    s.brainWork.push({id:uid(), t:"", u:"×”×©×‘×•×¢", day:"", time:"", mdate:"", important:false, order:maxOrder+1});
    markDirty(); saveLocal(false);
    renderBrainTable("work");
  };
  $("addBrainPersonal").onclick = ()=>{
    s.visPersonal = Math.max(MIN_TOP_ROWS, (s.visPersonal||MIN_TOP_ROWS) + 1);
    const maxOrder = Math.max(0, ...s.brainPersonal.map(x=>x.order??0));
    s.brainPersonal.push({id:uid(), t:"", u:"×”×©×‘×•×¢", day:"", time:"", mdate:"", important:false, order:maxOrder+1});
    markDirty(); saveLocal(false);
    renderBrainTable("personal");
  };

  $("addWeekRow").onclick = ()=>{
    s.weekRowCount += 1;
    ensureWeekMatrix();
    markDirty(); saveLocal(false);
    renderWeek();
  };

  $("prevWeek").onclick = ()=>{ setCurrentWeek(addDaysIso(s.currentWeekStart, -7)); saveLocal(false); renderWeek(); };
  $("nextWeek").onclick = ()=>{ setCurrentWeek(addDaysIso(s.currentWeekStart,  7)); saveLocal(false); renderWeek(); };
  $("btnWeekToday").onclick = ()=>{ setCurrentWeek(weekStartSundayIso(todayIso())); saveLocal(false); renderWeek(); };
  $("weekPick").onchange = (e)=>{
    const iso = String(e.target.value||"").trim();
    if(!iso) return;
    setCurrentWeek(weekStartSundayIso(iso));
    saveLocal(false);
    renderWeek();
  };

  // silent autosave to local + cloud flush if dirty
  setInterval(async ()=>{
    if(!dirty) return;
    saveLocal(false);
    await cloudSaveNow();
  }, 120000);

  renderBrain();
  renderWeek();

  setInfo(
    "××¦×‘: ××—×•×‘×¨ ×œ×¢× ×Ÿ\n" +
    "××©×ª××©: " + (user.email || "") + "\n" +
    "UserId: " + user.id + "\n" +
    "××¤×ª×— ××§×•××™: " + storageKey()
  );
}

async function initAuth(){
  try{
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });
  }catch(e){
    setErr("Supabase ×œ× × ×˜×¢×Ÿ. ×‘×“×§×™ ××™× ×˜×¨× ×˜ ××• ×©×”×›×ª×•×‘×ª ×•×”-Key ×ª×§×™× ×™×.");
    return;
  }

  bindAuthUi();
  setAuthMode("login");

  sb.auth.onAuthStateChange(async (_event, session)=>{
    if(session && session.user){
      await onSignedIn(session.user);
    } else {
      _qcUser = null;
      showLogin();
    }
  });

  const { data } = await sb.auth.getSession();
  if(data && data.session && data.session.user){
    await onSignedIn(data.session.user);
  } else {
    showLogin();
  }
}

/* =========================
   Weather (Tel Aviv) - Open-Meteo
   ========================= */
(function(){
  const LAT = 32.0853, LON = 34.7818;
  const CACHE_KEY = "qc_weather_v4";
  const CACHE_MIN = 60;
  const HEB = ["××³","×‘×³","×’×³","×“×³","×”×³","×•×³","×©×³"];

  function fmt(n){ return (n===null||n===undefined||Number.isNaN(Number(n))) ? "--" : (Math.round(Number(n))+"Â°"); }
  function typeFromCode(code){
    if(code===0) return "sun";
    if(code===1 || code===2) return "partly";
    if(code===3) return "cloud";
    return "cloud";
  }
  function setMsg(msg){
    const el = document.getElementById("weatherStrip");
    if(!el) return;
    el.innerHTML = `<div class="weatherLoading">${msg}</div>`;
  }
  function render(days){
    const el = document.getElementById("weatherStrip");
    if(!el) return;
    if(!Array.isArray(days) || !days.length){ setMsg("××–×’ ××•×•×™×¨ ×œ× ×–××™×Ÿ"); return; }

    el.innerHTML = days.slice(0,7).map(d=>{
      const wType = typeFromCode(d.code);
      const svg = (wType==="sun")
        ? `<svg class="wIcon" viewBox="0 0 64 64" aria-hidden="true"><circle cx="32" cy="32" r="16" fill="#F39A17"/></svg>`
        : (wType==="partly")
          ? `<svg class="wIcon" viewBox="0 0 64 64" aria-hidden="true"><circle cx="26" cy="26" r="14" fill="#F39A17"/><path d="M26 50h22a10 10 0 0 0 0-20c-.6 0-1.2.05-1.8.15A14 14 0 0 0 19.5 36 8.5 8.5 0 0 0 26 50Z" fill="#EDEFF2"/></svg>`
          : `<svg class="wIcon" viewBox="0 0 64 64" aria-hidden="true"><path d="M22 46h26a12 12 0 0 0 0-24c-.7 0-1.4.06-2.1.18A16 16 0 0 0 15.7 28.5 10 10 0 0 0 22 46Z" fill="#B9BDC3"/></svg>`;
      return `
        <div class="weatherDay" title="××™× ×™××•×-××§×¡×™××•×">
          <div class="wDayName">${d.name}</div>
          ${svg}
          <div class="wTemps"><span class="wMin">${fmt(d.min)}</span><span class="wMax">${fmt(d.max)}</span></div>
        </div>
      `;
    }).join("");

    // Mark today
    const heb = ["×","×‘","×’","×“","×”","×•","×©"];
    const israelNow = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Jerusalem" }));
    const todayHeb = heb[israelNow.getDay()];
    document.querySelectorAll('.weatherDay').forEach(card=>{
      const nm = card.querySelector('.wDayName');
      if(!nm) return;
      const first = (nm.textContent || "").trim()[0];
      if(first === todayHeb) card.classList.add("today");
    });
  }
  function getCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.t || !obj.days) return null;
      const age = (Date.now()-obj.t)/60000;
      if(age > CACHE_MIN) return null;
      return obj.days;
    }catch(e){ return null; }
  }
  function setCache(days){
    try{ localStorage.setItem(CACHE_KEY, JSON.stringify({t:Date.now(), days})); }catch(e){}
  }
  async function fetchMeteo(){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weathercode,temperature_2m_max,temperature_2m_min&forecast_days=7&timezone=auto`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("http_"+res.status);
    return await res.json();
  }
  async function init(){
    const cached = getCache();
    if(cached){ render(cached); return; }
    setMsg("×˜×•×¢×Ÿ ××–×’ ××•×•×™×¨...");
    try{
      const om = await fetchMeteo();
      const times = om?.daily?.time || [];
      const mins  = om?.daily?.temperature_2m_min || [];
      const maxs  = om?.daily?.temperature_2m_max || [];
      const codes = om?.daily?.weathercode || [];
      const days = times.slice(0,7).map((t,i)=>{
        const d = new Date(t+"T12:00:00");
        return { name: HEB[d.getDay()], min: mins[i], max: maxs[i], code: codes[i] };
      });
      setCache(days);
      render(days);
    }catch(e){
      setMsg("××–×’ ××•×•×™×¨ ×œ× ×–××™×Ÿ");
    }
  }
  window.addEventListener("load", init);
})();

/* =========================
   Boot
   ========================= */
document.addEventListener("DOMContentLoaded", ()=>{ initAuth(); });
</script>

</body>
</html>
