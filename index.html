<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuietControl</title>
  <style>
    body{margin:0;font-family:Arial;background:#f7f7f7;padding:28px}
    .container{max-width:860px;margin:auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 0 14px rgba(0,0,0,0.08)}
    h1{margin:0 0 6px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid #e7e7e7;border-radius:12px;padding:14px;background:#fafafa}
    label{display:block;font-size:13px;margin-top:10px;color:#333}
    input{width:100%;box-sizing:border-box;padding:10px;margin-top:6px;border:1px solid #cfcfcf;border-radius:10px;font-size:15px;background:#fff}
    button{margin-top:12px;padding:10px 14px;border-radius:10px;border:1px solid #999;background:#eee;cursor:pointer;font-size:14px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{margin-top:12px;padding:10px;border-radius:10px;background:#f1f1f1;font-size:13px;line-height:1.4;white-space:pre-line;min-height:18px}
    .ok{background:#eef8ee;color:#0b6b0b}
    .err{background:#fdecec;color:#b00020}
    .muted{color:#666;font-size:12px;margin-top:8px;line-height:1.35}
    #app{display:none}
    textarea{width:100%;height:220px;margin-top:10px;box-sizing:border-box;border:1px solid #cfcfcf;border-radius:10px;padding:10px;font-size:14px;background:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    code{direction:ltr}
  </style>
</head>

<body>
  <div class="container">
    <h1>QuietControl</h1>
    <div class="muted">התחברות הכי פשוטה למוצר: מייל + סיסמה. הנתונים נשמרים בענן לפי המשתמש.</div>

    <div id="globalStatus" class="status"></div>

    <div id="auth" class="grid" style="margin-top:12px;">
      <div class="card">
        <h3 style="margin:0 0 6px 0;">הרשמה</h3>
        <label>מייל</label>
        <input id="regEmail" type="email" placeholder="name@example.com" autocomplete="email">
        <label>סיסמה</label>
        <input id="regPass" type="password" placeholder="לפחות 6 תווים" autocomplete="new-password">
        <button id="registerBtn" type="button">צור משתמש</button>
        <div id="regStatus" class="status"></div>
        <div class="muted">
          אם ב-Supabase מופעל Email confirmations, המשתמש יווצר אבל ייתכן שיידרש אישור מייל לפני התחברות.
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 6px 0;">התחברות</h3>
        <label>מייל</label>
        <input id="logEmail" type="email" placeholder="name@example.com" autocomplete="email">
        <label>סיסמה</label>
        <input id="logPass" type="password" placeholder="הקלידי סיסמה" autocomplete="current-password">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="loginBtn" type="button">התחבר</button>
          <button id="resetBtn" type="button">איפוס סיסמה</button>
        </div>
        <div id="logStatus" class="status"></div>
      </div>
    </div>

    <div id="app" class="card" style="margin-top:14px;">
      <div class="row">
        <div>
          <div style="font-weight:700">מחוברת</div>
          <div id="userInfo" class="muted"></div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="loadBtn" type="button">טען מהענן</button>
          <button id="saveBtn" type="button">שמור לענן</button>
          <button id="logoutBtn" type="button">התנתק</button>
        </div>
      </div>

      <textarea id="stateBox" placeholder="כאן יישמר המידע שלך..."></textarea>
      <div id="appStatus" class="status"></div>
      <div class="muted">הטבלה: <code>qc_states</code> לפי <code>user_id</code> בלבד.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ערכים שלך (להשאיר בדיוק כך)
    const SUPABASE_URL = "https://xbvxjyiatcpvdcmakxwz.supabase.co";
    const SUPABASE_KEY = "sb_publishable_k8Drp1fN_c3509HkTyAKKw_ETsiUgZS";

    const el = (id) => document.getElementById(id);

    function setStatus(id, msg, kind){
      const box = el(id);
      box.textContent = msg || "";
      box.className = "status" + (kind ? (" " + kind) : "");
    }

    // הצגת שגיאות JS על המסך (כדי שלא יהיה "לא קורה כלום")
    window.addEventListener("error", (e) => {
      setStatus("globalStatus", "שגיאת מערכת:\n" + (e?.message || "unknown error"), "err");
    });
    window.addEventListener("unhandledrejection", (e) => {
      const msg = e?.reason?.message || String(e?.reason || "unknown rejection");
      setStatus("globalStatus", "שגיאה לא מטופלת:\n" + msg, "err");
    });

    function assertConfig(){
      if (!window.supabase || !window.supabase.createClient){
        setStatus("globalStatus", "Supabase לא נטען. בדקי חסימה ברשת/תוסף.", "err");
        return false;
      }
      if (!SUPABASE_URL.startsWith("https://") || !SUPABASE_URL.includes(".supabase.co")){
        setStatus("globalStatus", "SUPABASE_URL לא תקין.", "err");
        return false;
      }
      if (!SUPABASE_KEY.startsWith("sb_")){
        setStatus("globalStatus", "SUPABASE_KEY לא תקין.", "err");
        return false;
      }
      setStatus("globalStatus", "מוכן. אפשר להירשם או להתחבר.", "ok");
      return true;
    }

    const client = assertConfig() ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

    function showAuth(){
      el("auth").style.display = "grid";
      el("app").style.display = "none";
    }
    function showApp(session){
      el("auth").style.display = "none";
      el("app").style.display = "block";
      el("userInfo").textContent = "מייל: " + (session?.user?.email || "");
    }

    async function refreshUI(){
      if (!client) return;
      const { data: { session }, error } = await client.auth.getSession();
      if (error){
        setStatus("globalStatus", "שגיאה בקבלת Session:\n" + error.message, "err");
        showAuth();
        return;
      }
      if (session){
        showApp(session);
        await loadState();
      } else {
        showAuth();
      }
    }

    async function register(){
      try{
        setStatus("regStatus", "", "");
        const email = (el("regEmail").value || "").trim();
        const pass = (el("regPass").value || "").trim();

        if (!email || !email.includes("@")) { setStatus("regStatus", "נא להזין מייל תקין.", "err"); return; }
        if (pass.length < 6) { setStatus("regStatus", "סיסמה קצרה מדי. מינימום 6 תווים.", "err"); return; }

        el("registerBtn").disabled = true;
        setStatus("regStatus", "יוצר משתמש...", "");

        const { data, error } = await client.auth.signUp({ email, password: pass });
        if (error) throw error;

        // גם אם confirmations דולק, כאן לפחות תראי הודעה ולא "כלום"
        const note = data?.user ? "נוצר משתמש. עכשיו התחברי." : "הבקשה נשלחה. ייתכן שנדרש אישור מייל לפני התחברות.";
        setStatus("regStatus", note, "ok");
      } catch (e){
        setStatus("regStatus", "שגיאה בהרשמה:\n" + (e?.message || String(e)), "err");
      } finally {
        el("registerBtn").disabled = false;
      }
    }

    async function login(){
      try{
        setStatus("logStatus", "", "");
        const email = (el("logEmail").value || "").trim();
        const pass = (el("logPass").value || "").trim();

        if (!email || !email.includes("@")) { setStatus("logStatus", "נא להזין מייל תקין.", "err"); return; }
        if (!pass) { setStatus("logStatus", "נא להזין סיסמה.", "err"); return; }

        el("loginBtn").disabled = true;
        setStatus("logStatus", "מתחבר...", "");

        const { error } = await client.auth.signInWithPassword({ email, password: pass });
        if (error) throw error;

        setStatus("logStatus", "התחברת בהצלחה.", "ok");
        await refreshUI();
      } catch (e){
        setStatus("logStatus", "שגיאה בהתחברות:\n" + (e?.message || String(e)), "err");
      } finally {
        el("loginBtn").disabled = false;
      }
    }

    async function resetPassword(){
      try{
        setStatus("logStatus", "", "");
        const email = (el("logEmail").value || "").trim();
        if (!email || !email.includes("@")) { setStatus("logStatus", "נא להזין מייל כדי לאפס סיסמה.", "err"); return; }

        el("resetBtn").disabled = true;
        setStatus("logStatus", "שולח מייל איפוס...", "");

        const { error } = await client.auth.resetPasswordForEmail(email);
        if (error) throw error;

        setStatus("logStatus", "נשלח מייל איפוס. בדקי ספאם.", "ok");
      } catch (e){
        setStatus("logStatus", "שגיאה באיפוס:\n" + (e?.message || String(e)), "err");
      } finally {
        el("resetBtn").disabled = false;
      }
    }

    async function loadState(){
      try{
        setStatus("appStatus", "", "");
        const { data: { session } } = await client.auth.getSession();
        if (!session) { showAuth(); return; }

        el("loadBtn").disabled = true;
        setStatus("appStatus", "טוען מהענן...", "");

        const userId = session.user.id;
        const { data, error } = await client
          .from("qc_states")
          .select("state_json")
          .eq("user_id", userId)
          .maybeSingle();

        if (error) throw error;

        el("stateBox").value = data?.state_json || "";
        setStatus("appStatus", "נטען מהענן.", "ok");
      } catch (e){
        setStatus("appStatus", "שגיאה בטעינה:\n" + (e?.message || String(e)) + "\n\nאם הטבלה לא קיימת או RLS לא מוגדר, זה יכשל.", "err");
      } finally {
        el("loadBtn").disabled = false;
      }
    }

    async function saveState(){
      try{
        setStatus("appStatus", "", "");
        const { data: { session } } = await client.auth.getSession();
        if (!session) { showAuth(); return; }

        el("saveBtn").disabled = true;
        setStatus("appStatus", "שומר לענן...", "");

        const userId = session.user.id;
        const value = el("stateBox").value || "";

        const { error } = await client
          .from("qc_states")
          .upsert({ user_id: userId, state_json: value }, { onConflict: "user_id" });

        if (error) throw error;

        setStatus("appStatus", "נשמר לענן בהצלחה.", "ok");
      } catch (e){
        setStatus("appStatus", "שגיאה בשמירה:\n" + (e?.message || String(e)) + "\n\nאם הטבלה לא קיימת או RLS לא מוגדר, זה יכשל.", "err");
      } finally {
        el("saveBtn").disabled = false;
      }
    }

    async function logout(){
      await client.auth.signOut();
      location.reload();
    }

    el("registerBtn").addEventListener("click", register);
    el("loginBtn").addEventListener("click", login);
    el("resetBtn").addEventListener("click", resetPassword);
    el("loadBtn").addEventListener("click", loadState);
    el("saveBtn").addEventListener("click", saveState);
    el("logoutBtn").addEventListener("click", logout);

    refreshUI();
  </script>
</body>
</html>
