<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QuietControl</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f9}
#login,#app{max-width:600px;margin:80px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.08)}
input,button,textarea{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:1px solid #ccc}
button{background:#111827;color:#fff;border:none;cursor:pointer}
button.secondary{background:#e5e7eb;color:#111}
#app{display:none}
textarea{height:150px}
</style>
</head>

<body>

<div id="login">
<h2>התחברות / הרשמה</h2>
<input id="email" placeholder="מייל">
<input id="password" type="password" placeholder="סיסמה">
<button onclick="signIn()">התחברות</button>
<button class="secondary" onclick="signUp()">הרשמה</button>
<div id="msg" style="margin-top:10px;color:#b00020"></div>
</div>

<div id="app">
<h2>QuietControl</h2>
<textarea id="tasks" placeholder="כתבי כאן משימות..."></textarea>
<button onclick="saveData()">שמור</button>
<button class="secondary" onclick="logout()">התנתקות</button>
<div id="saveMsg" style="margin-top:10px;color:#157a15"></div>
</div>

<script>

const SUPABASE_URL = "https://xbvxjyiatcpvdcmakxwz.supabase.co";
const SUPABASE_KEY = "PASTE_YOUR_PUBLIC_KEY_HERE";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

async function checkSession(){
  const { data } = await supabase.auth.getSession();
  if(data.session){
    currentUser = data.session.user;
    showApp();
    loadData();
  }
}

function showApp(){
  document.getElementById("login").style.display="none";
  document.getElementById("app").style.display="block";
}

function showLogin(){
  document.getElementById("app").style.display="none";
  document.getElementById("login").style.display="block";
}

async function signUp(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  const { error } = await supabase.auth.signUp({email,password});
  if(error) return showMsg(error.message);
  showMsg("נרשמת. עכשיו התחברי.",false);
}

async function signIn(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  const { data,error } = await supabase.auth.signInWithPassword({email,password});
  if(error) return showMsg(error.message);
  currentUser=data.user;
  showApp();
  loadData();
}

async function logout(){
  await supabase.auth.signOut();
  currentUser=null;
  showLogin();
}

function showMsg(t,isErr=true){
  const el=document.getElementById("msg");
  el.style.color=isErr?"#b00020":"#157a15";
  el.textContent=t;
}

async function saveData(){
  if(!currentUser) return;
  const tasks=document.getElementById("tasks").value;

  await supabase
    .from("qc_states")
    .upsert({user_id:currentUser.id,state_json:tasks},{onConflict:"user_id"});

  document.getElementById("saveMsg").textContent="נשמר לענן";
}

async function loadData(){
  const { data } = await supabase
    .from("qc_states")
    .select("state_json")
    .eq("user_id",currentUser.id)
    .maybeSingle();

  if(data && data.state_json){
    document.getElementById("tasks").value=data.state_json;
  }
}

checkSession();

</script>
</body>
</html>
