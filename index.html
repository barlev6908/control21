<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuietControl E27.6.31.2 (Clean+RowColor)</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --card:#ffffff;
      --ink:#2a2a2a;
      --muted:#6a6a6a;
      --line:#e5e7f2;

      --radius:16px;

      --fontBody: Arial, sans-serif;
      --fontHead: "Poppins","Heebo","Rubik","Assistant", Arial, sans-serif;

      --ok:#2e9b63;
      --bad:#c0392b;

      --theadBg:#aeeeee;
      --theadInk:#134b4b;

      --turqBorder:#7fdede;
      --accentLogin:#bfeeee;

      /* Pastel urgency colors */
      --uTodayBg: rgba(166, 238, 198, 0.55);   /* pastel green */
      --uTodayBd: rgba(46, 155, 99, 0.35);

      --uWeekBg:  rgba(255, 214, 165, 0.55);   /* pastel orange */
      --uWeekBd:  rgba(220, 135, 35, 0.30);

      --uMonthBg: rgba(191, 224, 255, 0.60);   /* pastel blue */
      --uMonthBd: rgba(70, 140, 210, 0.25);
    }

    body{
      margin:0;
      font-family:var(--fontBody);
      background:linear-gradient(180deg,#f3f5ff,#fafbff);
      color:var(--ink);
      min-height:100vh;
    }

    /* ---------- LOGIN ---------- */
    #loginWrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .loginCard{
      width:min(520px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,0.06);
      padding:18px;
    }
    .loginBrand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 4px;
    }
    .loginTitle{
      margin:0;
      font-family:var(--fontHead);
      font-size: 6px;
      font-weight:800;
      letter-spacing:0.2px;
    }
    .loginSub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      font-family:var(--fontHead);
    }
    .pill{
      background:rgba(191,238,238,0.35);
      border:1px solid rgba(191,238,238,0.9);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:#0f5555;
      white-space:nowrap;
      font-family:var(--fontHead);
      font-weight:700;
    }
    .loginLabel{
      display:block;
      margin-top:14px;
      margin-bottom:6px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      font-family:var(--fontHead);
    }
    #pw{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:14px;
      outline:none;
      box-sizing:border-box;
      font-family:var(--fontBody);
      background:#fff;
    }
    #pw:focus{
      border-color:rgba(127,222,222,0.9);
      box-shadow:0 0 0 3px rgba(127,222,222,0.25);
    }
    .loginRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .loginBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
      font-weight:800;
      font-family:var(--fontHead);
    }
    .loginPrimary{
      background:var(--accentLogin);
      border-color:rgba(127,222,222,0.9);
      color:#0f5555;
    }
    .loginGhost{ color:var(--muted); }
    #err{
      margin-top:10px;
      color:var(--bad);
      font-size:12.5px;
      display:none;
      font-weight:800;
      font-family:var(--fontHead);
    }
    .loginHint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* ---------- APP ---------- */
    #appWrap{ display:none; min-height:100vh; }

    .topbar{
      position:sticky;
      top:0;
      z-index:9999;
      background:rgba(255,255,255,0.92);
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .topbarLeft{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .topbar .mini{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      font-family:var(--fontHead);
    }
    .logout{
      border:1px solid rgba(192,57,43,0.35);
      background:rgba(192,57,43,0.10);
      color:var(--bad);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
      font-family:var(--fontHead);
    }
    .saveBtn{
      border:1px solid rgba(46,155,99,0.35);
      background:rgba(46,155,99,0.12);
      color:var(--ok);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
      font-family:var(--fontHead);
    }
    #saveState{
      display:none;
      font-size:12px;
      color:var(--ok);
      font-weight:900;
      font-family:var(--fontHead);
    }

    .wrap{max-width:1260px;margin:8px auto 14px;padding:0 12px;}
    .grid{display:grid;grid-template-columns: 1fr 320px;gap:10px;}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:10px;
      margin-bottom:10px;
    }

    h1,h2{font-family:var(--fontHead);}
    h1{margin:0;font-size:20px;line-height:1.1;}
    h2{margin:0 0 6px;font-size:16.5px;line-height:1.1;}
    .small{font-size:11px;color:var(--muted);line-height:1.25;}

    .monthTitle{
      margin:6px 0 10px;
      font-family:var(--fontHead);
      font-size:20px;
      font-weight:900;
      color:#0f3f33;
      letter-spacing:0.2px;
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .monthTitle .year{
      font-size:12px;
      font-weight:800;
      color:rgba(15,63,51,0.75);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
    }
    th,td{border-bottom:1px solid var(--line);padding:6px;font-size:12.5px;vertical-align:top;}
    th{
      font-family:var(--fontHead);
      font-weight:700;
      background:var(--theadBg);
      color:var(--theadInk);
      font-size:14px;
    }
    tbody tr:last-child td{border-bottom:none;}

    input,select,textarea{
      width:100%;
      padding:5px 6px;
      border:1px solid var(--line);
      border-radius:10px;
      font-size:12px;
      font-family:inherit;
      background:#fff;
      box-sizing:border-box;
    }

    button{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:5px 7px;
      cursor:pointer;
      font-size:11px;
      line-height:1.1;
      font-family:var(--fontHead);
    }

    .primary{background:#f1f2ff;font-weight:700;}

    .btnDanger{
      border-color: rgba(192,57,43,0.45);
      background: rgba(192,57,43,0.12);
      color: var(--bad);
      font-weight:700;
    }

    .btnOk{
      border-color: rgba(46,155,99,0.45);
      background: rgba(46,155,99,0.12);
      color: var(--ok);
      font-weight:900;
    }

    .hr{height:1px;background:var(--line);margin:8px 0;}

    .top th, .top td{padding:6px;font-size:12px;}
    .top textarea.taskText{
      min-height:36px;
      font-size:12px;
      padding:5px 6px;
      resize:none;
      overflow:auto;
    }

    /* Top row cards + drag */
    .top tr.brRow{ cursor:grab; }
    .top tr.brRow.dragging{ opacity:0.55; }
    .top tr.brRow.dropHover{ outline:2px solid rgba(125,145,255,0.45); outline-offset:-2px; }

    /* Pastel urgency row coloring */
    .uTodayRow td{ background: var(--uTodayBg); }
    .uWeekRow  td{ background: var(--uWeekBg);  }
    .uMonthRow td{ background: var(--uMonthBg); }

    /* Month column bold */
    .monthLbl{ font-weight:900; font-family:var(--fontHead); }

    .brainActions{
      display:flex;
      gap:6px;
      flex-wrap:nowrap;
      justify-content:flex-start;
      align-items:center;
    }

    .timeQuick{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
      justify-content:flex-start;
    }
    .timeQuick button{
      border-radius:999px;
      padding:5px 8px;
      font-size:10.8px;
      white-space:nowrap;
      background:rgba(255,255,255,0.7);
    }

    /* Weekly table */
    .week2 th, .week2 td{
      padding:2px;
      font-size:11.2px;
      text-align:center;
      vertical-align:middle;
    }
    .week2 .rowHead{
      font-weight:700;
      font-family:var(--fontHead);
      background:var(--theadBg);
      color:var(--theadInk);
      text-align:right;
      padding-right:7px;
      white-space:nowrap;
      font-size:13px;
    }
    .week2 .dayHead{
      font-weight:800;
      font-family:var(--fontHead);
      background:var(--theadBg);
      color:var(--theadInk);
      font-size:12.8px;
      line-height:1.1;
    }
    .dayDate{
      display:block;
      font-size:11px;
      font-weight:700;
      color:rgba(19,75,75,0.78);
      margin-top:2px;
    }
    .week2 .taskCell{
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      padding:4px 6px;
      min-height:28px;
      line-height:1.15;
      user-select:none;
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:6px;
      justify-content:center;
    }
    .taskCell.empty{
      background:#fcfcff;
      border-style:dashed;
      border-color:#dfe3f7;
      align-items:flex-start;
      padding-left: 4px;
      padding-bottom:4px;
    }
    .taskCell.empty:hover{
      background:#f7f8ff;
      border-color:#cfd6ff;
    }
    .taskCell.empty .pencil{display:none;}
    .taskMain{
      display:flex;
      flex-direction:column;
      gap:2px;
      text-align:right;
    }
    .taskTopic{
      font-size:12.6px;
      font-weight:900;
      font-family:var(--fontHead);
      white-space:normal;
      word-break:break-word;
    }
    .taskMeta{
      font-size:11px;
      color:var(--muted);
      font-weight:800;
      white-space:normal;
      word-break:break-word;
    }

    .taskCell.done{
      border-color: rgba(46,155,99,0.45);
      background: rgba(46,155,99,0.12);
      color: var(--ok);
    }
    .taskCell.notdone{
      border-color: rgba(192,57,43,0.55);
      background: rgba(192,57,43,0.14);
      color: var(--bad);
    }

    .taskCell.draggable{ cursor:grab; }
    .taskCell.dragging{ opacity:0.55; }
    .taskCell.dropHover{
      outline:2px solid rgba(125,145,255,0.45);
      outline-offset:2px;
    }

    .popover{
      position:fixed;
      z-index:9999;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px;
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
      width:190px;
      font-family:var(--fontBody);
    }
    .popTitle{
      font-family:var(--fontHead);
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    .popHint{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.25;}
    .popBtns{display:flex;gap:8px;}
    .popBtns button{flex:1;border-radius:999px;padding:6px 8px;font-size:11.5px;}
    .popOk{
      border-color: rgba(46,155,99,0.45);
      background: rgba(46,155,99,0.12);
      color: var(--ok);
      font-weight:700;
    }
    .popBad{
      border-color: rgba(192,57,43,0.45);
      background: rgba(192,57,43,0.12);
      color: var(--bad);
      font-weight:700;
    }

    .statusBtn{
      padding:3px 8px;
      border-radius:999px;
      font-size:10.8px;
      white-space:nowrap;
      font-family:var(--fontHead);
      background:rgba(255,255,255,0.7);
    }

    .side .card{padding:10px;}
    .side h2{font-size:14.5px;}
    .side textarea{min-height:56px !important;}

    .sideNotes textarea{
      min-height:120px !important;
      resize:none;
    }

    .banner{
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--line);
      margin-bottom:10px;
      position:relative;
      height:86px;
      background:
        linear-gradient(90deg,
          rgba(155, 220, 190, 0.72),
          rgba(155, 220, 190, 0.40),
          rgba(155, 220, 190, 0.18)
        );
    }
    .banner .bannerText{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      padding:12px 14px;
    }
    .bannerTitle{
      font-family:var(--fontHead);
      font-weight:700;
      font-size:22px;
      color:#0f3f33;
      letter-spacing:0.3px;
    }
    .bannerSub{
      margin-top:4px;
      font-family:var(--fontHead);
      font-weight:500;
      font-size:12.5px;
      color:rgba(15,63,51,0.88);
      letter-spacing:0.25px;
    }

    .top th:last-child,
    .top td:last-child,
    .week2 th:last-child,
    .week2 td:last-child{
      border-left:2px solid var(--turqBorder);
    }

    @media(max-width:1000px){
      .grid{grid-template-columns:1fr;}
    }
  
/* --- E27.6.31.2: ensure row background covers actions column --- */
#brainTable tr td{ background: transparent !important; }
#brainTable tr td:first-child{ background: transparent !important; }
#brainTable tr td.actionsCell{ background: transparent !important; }


/* --- E27.6.31.2: soften top table row colors to very light pastels --- */
#brainTable tr.row-today { background-color: #eefaf6 !important; }
#brainTable tr.row-week  { background-color: #fff6ec !important; }
#brainTable tr.row-month { background-color: #eef5ff !important; }

/* Ensure no white cells override */
#brainTable tr td { background-color: transparent !important; }


/* --- E27.6.31.2: ultra-light pastel row colors + remove white strip in actions column --- */
:root{
  --uTodayBg: #f1fbf7;   /* very light mint */
  --uWeekBg:  #fff7ef;   /* very light peach */
  --uMonthBg: #f1f6ff;   /* very light sky */
}

/* Ensure row color applies to ALL cells (including actions) */
.uTodayRow td{ background: var(--uTodayBg) !important; }
.uWeekRow  td{ background: var(--uWeekBg)  !important; }
.uMonthRow td{ background: var(--uMonthBg) !important; }

/* Buttons inside actions: remove solid white fills so row color is visible */
td.brainActions button{
  background: transparent !important;
}
td.brainActions .btnOk,
td.brainActions .btnWA,
td.brainActions .btnReset,
td.brainActions .btnDanger{
  background: transparent !important;
}


/* --- E27.6.31.2: Option B - actions colored like row + table grid lines --- */

/* Ensure actions column follows row color */
.uTodayRow td.brainActions,
.uWeekRow td.brainActions,
.uMonthRow td.brainActions {
  background-color: inherit !important;
}



/* --- E27.6.31.2: align horizontal grid lines with task rows (actions column fix) --- */

/* Remove internal borders that break alignment */
#brainTable td.brainActions {
  border-bottom: none !important;
}

/* Apply row-level horizontal separator instead */
#brainTable tr {
  border-bottom: 1px solid #e3e9ee;
}

/* Remove duplicate bottom border on last row */
#brainTable tr:last-child {
  border-bottom: none;
}


/* --- E27.6.31.2: fix actions-column stripe by applying borders on the TD itself (aligned per row) --- */
#brainTable{
  border-collapse: collapse;   /* ensures borders align perfectly */
  width: 100%;
}
#brainTable th,
#brainTable td{
  border: 1px solid #e3e9ee !important;
}

/* Keep row coloring (already applied via td backgrounds) */
#brainTable td.brainActionsTd{
  /* explicitly keep same bg as row (Option B) */
  background-color: inherit !important;
}

/* Remove any "internal" line under the action buttons (comes from global th,td border rules) */
#brainTable td.brainActionsTd > .brainActions{
  border: none !important;
}


/* --- E27.6.31.2: FIX - apply grid lines and row coloring to the REAL top table (.top) --- */
.top{ border-collapse: collapse !important; width:100%; }
.top th, .top td{ border:1px solid #e3e9ee !important; }

/* Row pastel coloring should cover ALL columns, including actions */
.top tr.uTodayRow td{ background: var(--uTodayBg) !important; }
.top tr.uWeekRow  td{ background: var(--uWeekBg)  !important; }
.top tr.uMonthRow td{ background: var(--uMonthBg) !important; }

/* Remove any “extra” underline look inside actions cell */
.top td .brainActions button{ box-shadow:none !important; }


/* --- E27.6.31.2: Bottom table free text cells --- */
.bottom table td {
  vertical-align: top;
}

.bottom textarea.weekCell {
  width: 100%;
  min-height: 48px;
  resize: vertical;
  border: none;
  outline: none;
  background: transparent;
  font-family: inherit;
  font-size: 14px;
  line-height: 1.4;
}


/* --- E27.6.31.2: Wider weekly cells --- */
.bottom table{
  width:100%;
  table-layout: fixed;
}
/* Keep side columns narrow so day columns get room */
.bottom th:first-child, .bottom td:first-child{ width: 110px !important; } /* actions / clear */
.bottom th:last-child, .bottom td:last-child{ width: 90px !important; }  /* row label / day */
.bottom th.dayHeader, .bottom td.day-cell{ width: auto; }

/* Make the writing area feel like a real note */
.bottom textarea.weekCell{
  min-height: 70px;
  font-size: 15px;
  font-weight: 700;
  padding: 10px 8px;
  border-radius: 12px;
  border: 1px dashed rgba(120,160,175,0.55);
  background: rgba(255,255,255,0.85);
  box-sizing: border-box;
  overflow-wrap: anywhere;
}


.weekNav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.weekTitle{display:flex;flex-direction:column;align-items:center;min-width:180px;}
.weekTitleMain{font-weight:700;}
.weekTitleSub{font-size:12px;opacity:0.8;}
.wBtn{padding:8px 10px;border:1px solid #cfd6e4;border-radius:10px;background:#fff;cursor:pointer;}
.wDate{padding:7px 10px;border:1px solid #cfd6e4;border-radius:10px;}


/* --- E27.6.31.2: Work + Personal duplicated top tables --- */
:root{
  --hdrWorkBg: #aeeeee;    /* תכלת */
  --hdrWorkInk:#134b4b;
  --hdrPersonalBg:#ffe59a; /* צהוב */
  --hdrPersonalInk:#5a4b00;
}
.tblSectionTitle{
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
  font-family:var(--fontHead);
  font-weight:900;
  font-size:16px;
  margin:10px 0 8px;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  letter-spacing:0.2px;
}
.tblSectionTitle.work{
  background: var(--hdrWorkBg);
  color: var(--hdrWorkInk);
  border-color: rgba(127,222,222,0.9);
}
.tblSectionTitle.personal{
  background: var(--hdrPersonalBg);
  color: var(--hdrPersonalInk);
  border-color: rgba(255, 210, 80, 0.65);
}


/* --- Unified header color (turquoise) for top tables --- */
.workTable th,
.personalTable th{
  background:#cfeff1 !important; /* טורקיז עדין */
  color:#0b5f66 !important;
}

/* --- Pencil icon for empty weekly cells (tiny SVG) --- */
.week2 .taskCell.empty{
  position: relative;
}
.week2 .taskCell.empty::after{
  content: "";
  position: absolute;
  left: 4px;
  bottom: 4px;
  width: 8px;
  height: 8px;
  background-repeat: no-repeat;
  background-size: 8px 8px;
  opacity: 0.25;
  pointer-events: none;
  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%239aa3b2' d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.33H5v-.92l9.06-9.06.92.92L5.92 19.58zM20.71 7.04a1.003 1.003 0 0 0 0-1.42L18.37 3.29a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.83z'/></svg>");
}
.week2 .taskCell.empty::after{
  content: "";
  position: absolute;
  left: 6px;
  bottom: 6px;
  font-size: 14px;
  opacity: 0.6;
  pointer-events: none;
}


/* --- Important task star (top tables) --- */
.btnStar{
  border: 1px solid rgba(212,175,55,0.45);
  background: rgba(212,175,55,0.10);
  color: rgba(120,120,120,0.9);
  font-weight: 900;
  width: 34px;
  min-width: 34px;
  padding: 5px 0;
  border-radius: 999px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.btnStar.on{
  background: rgba(212,175,55,0.18);
  color: #d4af37;
  border-color: rgba(212,175,55,0.65);
}


/* --- Compact icon buttons in Actions column --- */
.brainActions .iconBtn{
  width: 30px;
  min-width: 30px;
  height: 28px;
  padding: 0;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  line-height: 1;
}
.brainActions{
  gap: 6px;
}


/* --- Emphasize important star --- */
.brainActions .btnStar{
  font-size: 18px;        /* bigger star */
}
.brainActions .btnStar.on{
  font-size: 20px;        /* even more prominent when active */
  box-shadow: 0 0 0 1px rgba(212,175,55,0.25);
}


/* --- QC patch: weekly text wrap without overlap --- */
.week2 .taskCell{
  justify-content: space-between;
  min-height: 64px;
}
.week2 .taskMain{
  flex: 1 1 auto;
  overflow: hidden;
}
.week2 .taskTopic{
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 3;
  overflow: hidden;
}
.week2 .statusBtn{
  align-self: flex-start;
}


/* --- Weather strip (7-day) --- */
.banner{ display:flex; align-items:center; justify-content:space-between; gap:14px; }
.bannerLeft{ flex: 1 1 auto; overflow:hidden; display:flex; align-items:center; justify-content:flex-start; }
.weatherStrip{ display:flex; gap:10px; align-items:stretch; justify-content:flex-start; flex-wrap:nowrap; overflow-x:auto; padding-bottom:4px; }
.weatherStrip::-webkit-scrollbar{ height:6px; }
.weatherDay{
  width: 82px;
  min-width: 82px;
  border: 1.5px solid rgba(11,95,102,0.22);
  border-radius: 14px;
  padding: 8px 8px 6px;
  background: #ffffff;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:space-between;
  box-sizing:border-box;
}
.weatherDay .wDayName{ font-weight: 900; font-size: 12.5px; line-height: 1.1; opacity: 0.9; }
.weatherDay img{ width: 38px; height: 38px; display:block; }
.weatherDay .wTemps{ font-size: 12.5px; font-weight: 900; display:flex; gap:6px; align-items:baseline; }
.weatherDay .wMin{ opacity:0.75; }
.weatherDay .wMax{ opacity:0.95; }
.weatherLoading{ font-size: 12.5px; font-weight: 800; opacity: 0.7; padding: 6px 10px; }
@media (max-width: 980px){
  .weatherDay{ width:74px; min-width:74px; }
  .weatherDay img{ width:34px; height:34px; }
}


/* --- Weather strip refinements: smaller, left-aligned, pastel --- */
.banner{ justify-content:flex-start; }
.bannerLeft{ max-width: 60%; }

.weatherStrip{
  gap:8px;
}

.weatherDay{
  width:64px;
  min-width:64px;
  padding:6px 6px 5px;
  border-radius:12px;
  background: linear-gradient(180deg, #ffffff 0%, #f3fbf8 100%);
  border:1px solid rgba(80,170,160,0.35);
}

.weatherDay img{
  width:28px;
  height:28px;
}

.weatherDay .wDayName{
  font-size:11px;
}

.weatherDay .wTemps{
  font-size:11px;
}

.weatherDay .wMax{ color:#0f766e; } /* teal */
.weatherDay .wMin{ color:#64748b; } /* slate */


/* --- Banner hard layout fix: no overlap --- */
.banner{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
}
.bannerLeft{
  flex:0 0 auto;
  max-width:55%;
}
.bannerText{
  flex:0 0 auto;
  min-width:220px;
  text-align:right;
}


/* --- Banner direction fix (RTL page): keep weather truly left, prevent overlap --- */
.banner{
  direction: ltr;              /* make "left" actually left */
}
.bannerLeft{
  direction: ltr;
  flex: 1 1 auto;
  max-width: calc(100% - 260px);   /* reserve space for title */
}
.bannerText{
  direction: ltr;
  flex: 0 0 260px;                 /* fixed title area */
  max-width: 260px;
  margin-left: auto;
}
.weatherStrip{
  justify-content: flex-start;
}


/* --- Weather: TODAY highlight (subtle gold) --- */
.weatherDay.today{
  background: linear-gradient(180deg, #fff7df 0%, #ffefc2 100%) !important;
  border-color: rgba(242,201,76,0.9) !important;
}


/* --- Weather order fix: RTL (right to left) --- */
.weatherStrip{
  direction: rtl;
}
.weatherDay{
  direction: rtl;
}


/* --- Calendar table: lock day column widths, natural text wrap --- */
.calendarTable{
  table-layout: fixed;
  width: 100%;
}
.calendarTable th,
.calendarTable td{
  width: calc(100% / 7);
  vertical-align: top;
}
.calendarTable td{
  white-space: normal;
  word-break: break-word;
}


/* --- Calendar table (weekly): lock day columns no matter the text --- */
.week2{
  table-layout: fixed !important;
  width: 100% !important;
}
.week2 th, .week2 td{
  width: calc(100% / 7) !important;
  max-width: calc(100% / 7) !important;
  overflow: hidden !important;
  vertical-align: top;
}
.week2 td{
  white-space: normal !important;
  overflow-wrap: break-word !important;
  word-break: break-word !important;
}
.week2 .taskCell{
  width: 100% !important;
  box-sizing: border-box !important;
}
.week2 .taskTopic{
  max-width: 100% !important;
}


/* --- Calendar: green background when task exists --- */
.week2 td.hasTask{
  background: #f3fbf6 !important; /* soft green */
}


/* --- Calendar: green background when task exists (final) --- */
.week2 td.hasTask{
  background-color: #f3fbf6 !important;
}


/* --- Calendar: green background when cell has a task --- */
.week2 .taskCell.hasTask{
  background: #f3fbf6 !important;
}


/* --- Daypart buttons (Morning / Noon / Evening) --- */
.daypartCard{
  border: 1px solid var(--line);
  border-radius: 16px;
  background: #fff;
  padding: 12px;
  margin-bottom: 10px;
}
.daypartTitle{
  font-weight: 900;
  font-size: 14px;
  margin-bottom: 10px;
}
.daypartBtns{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.daypartBtn{
  width: 100%;
  border-radius: 14px;
  padding: 12px 10px;
  border: 1px solid rgba(242,201,76,0.55);
  background: #ffffff;
  font-weight: 900;
  cursor: pointer;
  transition: transform 120ms ease, background 160ms ease, box-shadow 160ms ease;
}
.daypartBtn:active{
  transform: scale(0.99);
}
.daypartBtn.isOn{
  background: linear-gradient(180deg, #fff7df 0%, #ffefc2 100%);
  box-shadow: 0 0 0 2px rgba(242,201,76,0.18) inset;
}


/* --- Daypart buttons refined style --- */
.daypartBtn{
  border-radius: 999px; /* pill shape */
  font-size: 14px;
  letter-spacing: 0.2px;
}
.daypartBtn.isOn{
  background: linear-gradient(180deg, #fff9e6 0%, #ffefc7 100%);
  box-shadow: 0 4px 10px rgba(242,201,76,0.25);
}


/* --- Month view modal (calendar grid + notes) --- */
.qcMonthOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.qcMonthOverlay.show{ display:flex; }
.qcMonthModal{
  width: min(520px, 92vw);
  max-height: 82vh;
  overflow: auto;
border-radius: 18px;
  background: #fff;
  border: 1px solid rgba(0,0,0,0.08);
  box-shadow: 0 18px 60px rgba(0,0,0,0.22);
  padding: 14px 14px 12px;
}
.qcMonthHead{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 10px;
}
.qcMonthTitle{
  font-weight: 900;
  font-size: 16px;
}
.qcMonthClose{
  border: 1px solid rgba(0,0,0,0.12);
  background: #fff;
  border-radius: 12px;
  width: 34px;
  height: 34px;
  cursor: pointer;
  font-weight: 900;
  font-size: 16px;
  line-height: 1;
  display:flex;
  align-items:center;
  justify-content:center;
}
.qcMonthCal{
  border: 1px solid rgba(0,0,0,0.12);
  border-radius: 16px;
  padding: 10px;
}
.qcMonthCalHead{
  display:flex;
  align-items:center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.qcMonthNav{
  border: 1px solid rgba(0,0,0,0.14);
  background: #fff;
  border-radius: 12px;
  width: 38px;
  height: 34px;
  cursor: pointer;
  font-weight: 900;
  font-size: 18px;
  line-height: 1;
}
.qcMonthCalLabel{
  font-weight: 900;
  font-size: 15px;
  opacity: 0.9;
}
.qcMonthDow{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  text-align:center;
  font-weight: 900;
  opacity: 0.65;
  font-size: 12px;
  margin-bottom: 6px;
}
.qcMonthGrid{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
}
.qcDay{
  height: 32px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.10);
  background: #fff;
  cursor: pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 900;
  position: relative;
}
.qcDay.empty{
  border-color: transparent;
  background: transparent;
  cursor: default;
}
.qcDay.today{
  outline: 2px solid rgba(242,201,76,0.35);
  outline-offset: 0px;
}
.qcDay.selected{
  border-color: rgba(242,201,76,0.65);
  background: linear-gradient(180deg, #fff7df 0%, #ffefc2 100%);
}
.qcDot{
  position:absolute;
  bottom: 6px;
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: rgba(34,153,84,0.55);
}
.qcMonthNoteMeta{
  margin-top: 10px;
  font-weight: 800;
  opacity: 0.75;
}
.qcMonthText{
  width: 100%;
  min-height: 110px;
  resize: vertical;
  border: 1px solid rgba(0,0,0,0.14);
  border-radius: 14px;
  padding: 10px 12px;
  font-size: 14px;
  line-height: 1.35;
  margin-top: 8px;
}
.qcMonthActions{
  display:flex;
  justify-content:flex-end;
  gap: 10px;
  margin-top: 10px;
}
.qcMonthBtn{
  border-radius: 999px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  border: 1px solid rgba(0,0,0,0.14);
  background: #fff;
}
.qcMonthBtn.primary{
  border-color: rgba(242,201,76,0.55);
  background: linear-gradient(180deg, #fff7df 0%, #ffefc2 100%);
}


/* --- Month calendar: day with saved note turns soft pink --- */
.qcDay.hasNote{
  background: #fde9f2 !important;
  border-color: rgba(226, 115, 163, 0.35) !important;
}
.qcDay.hasNote.isSelected{
  background: linear-gradient(180deg, #fff0f7 0%, #ffe1ef 100%) !important;
}


/* --- Remove tiny green dot indicator in month journal --- */
.qcDot{ display:none !important; }


/* --- FORCE pink background for days with notes --- */
.qcDay.hasNote{
  background-color: #fde9f2 !important;
  border-color: rgba(226,115,163,0.4) !important;
}


/* --- Weather icons: simplified 3 icons (sun/cloud/partly) --- */
.weatherDay .wIcon{
  width: 40px;
  height: 40px;
  display: block;
  margin: 6px auto 4px;
}


/* --- Rain icon subtle style --- */
.weatherDay .wRain g{ opacity:0.9; }


/* Daily Motivation */
.daily-motivation{
  font-family:'Guttman Yad','Arial',sans-serif;
  font-size:22px;
  font-weight:700;
  color:#C9A24D;
  text-align:center;
  background:rgba(255,215,150,0.18);
  padding:12px 20px;
  border-radius:14px;
  max-width:820px;
  margin:0 auto;
  line-height:1.3;
}

/* Motivation placement row */
.motivationRow{
  margin-top: 14px;

  width:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  padding: 10px 12px 2px;
}
.motivationRow .daily-motivation{
  text-align:center;
  direction:rtl;
  max-width: 920px;
}

/* Weather icon size refinement */
.weatherDay .wIcon{
  width:22px !important;
  height:22px !important;
  display:block;
  margin:2px auto 2px;
}
.weatherDay{
  overflow:visible !important;
}


#dailyMotivation { font-size: 26px; font-weight: 900; letter-spacing: 0.5px; }

/* --- QC: Word-like header toolbar + rich text editor (preserve original UI) --- */
th .thFlex{display:flex;align-items:center;justify-content:space-between;gap:8px;}
.qcHdrTools{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;}
.qcHdrTools .fmtBtn{
  width:22px;min-width:22px;height:22px;border-radius:8px;padding:0;
  background:rgba(255,255,255,0.75);
  border:1px solid rgba(19,75,75,0.22);
  cursor:pointer;
  display:inline-flex;align-items:center;justify-content:center;
}
.qcHdrTools .fmtBtn svg{width:14px;height:14px;fill: rgba(19,75,75,0.9);}
.qcHdrTools .fmtBtn.fmtRed svg{fill:#b00000;}

/* Make contenteditable look like the old textarea (and force I-beam cursor, not hand) */
.top .taskText{
  width:100%;
  min-height:36px;
  font-size:12px;
  padding:5px 6px;
  overflow:auto;
  border:1px solid var(--line);
  border-radius:10px;
  background:#fff;
  box-sizing:border-box;
  font-family:inherit;
  line-height:1.25;
  white-space:pre-wrap;
  word-break:break-word;
  outline:none;
  cursor:text !important;
}
.top .taskText:focus{
  border-color:rgba(127,222,222,0.9);
  box-shadow:0 0 0 3px rgba(127,222,222,0.20);
}
.top .taskText[data-placeholder]:empty:before{
  content: attr(data-placeholder);
  color: rgba(106,106,106,0.75);
}


/* Export to Excel button */
.fmtBtn.fmtExport{
  border-color:#cfe3d3;
  background:#eef8f0;
}
.fmtBtn.fmtExport svg{ width:16px; height:16px; }

</style>



  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<div class="daypartCard" id="daypartCard" aria-label="Daypart buttons" style="display:none;">
  <div class="daypartTitle">משימה חוזרת</div>
  <div class="daypartBtns">
    <button class="daypartBtn" id="btnMorning" type="button">בוקר</button>
    <button class="daypartBtn" id="btnNoon" type="button">צהריים</button>
    <button class="daypartBtn" id="btnEvening" type="button">ערב</button>
  </div>
</div>


<!-- LOGIN -->
<div id="loginWrap" style="display:flex;">
  <div class="loginCard">
    <div class="loginBrand">
      <div>
        <h1 class="loginTitle">QuietControl</h1>
        <div class="loginSub">Calm order. Real control.</div>
      </div>
      <div class="pill" id="authModePill">כניסה</div>
    </div>

    <label class="loginLabel" for="email">אימייל</label>
    <input id="email" type="email" autocomplete="username" placeholder="name@example.com" />

    <label class="loginLabel" for="pw">סיסמה</label>
    <input id="pw" type="password" autocomplete="current-password" placeholder="" />

    <label class="loginLabel" for="pw2" id="pw2Label" style="display:none;">אישור סיסמה</label>
    <input id="pw2" type="password" autocomplete="new-password" placeholder="" style="display:none;" />

    <div class="loginRow">
      <button class="loginBtn loginPrimary" id="btnLogin" type="button">היכנסי</button>
      <button class="loginBtn loginGhost" id="btnToggleMode" type="button">אין לי משתמש - הרשמה</button>
      <button class="loginBtn loginGhost" id="btnClear" type="button">נקה</button>
    </div>

    <div id="err" style="display:none;">שגיאה</div>

    <div class="loginHint">
      כדי שהלינק ייפתח לך מכל מחשב עם אותם נתונים, עובדים עם התחברות ושמירה בענן.
    </div>
    <div class="loginHint" style="margin-top:8px;">
      <b>חשוב:</b> צריך להדביק בקוד את SUPABASE_URL ואת SUPABASE_ANON_KEY כדי שזה יעבוד. בלי זה הנתונים יישמרו רק בדפדפן הזה.
    </div>
</div>
</div>

<!-- APP -->
<div id="appWrap" style="display:none;">
  <div class="topbar">
    <div class="topbarLeft">
      <div class="mini">QuietControl - גרסה E27.6.31.2 (Work+Personal)</div>
      <div class="mini" id="whoami" style="font-weight:900;"></div>
      <button class="saveBtn" id="btnSaveNow" type="button">שמור</button>
      <div id="saveState">נשמר</div>
      <div id="cloudState" style="display:none;font-size:12px;color:#0f5555;font-weight:900;font-family:var(--fontHead);">ענן: נשמר</div>
    </div>
    <button class="logout" id="btnLogout" type="button">התנתקות</button>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- MAIN -->
      <div>

        <div class="card">
          <div class="banner" aria-label="QuietControl banner">
            <div class="bannerLeft">
              <div class="weatherStrip" id="weatherStrip"><div class="weatherLoading">טוען מזג אוויר...</div></div>
            </div>
            <div class="bannerText">
              <div>
                <div class="bannerTitle">QuietControl</div>
                <div class="bannerSub">Calm order. Real control</div>
</div>
            </div>
          </div>

          <div class="motivationRow"><div class="daily-motivation" id="dailyMotivation"></div></div>
<div class="monthTitle" id="topMonthTitle">
            <span id="topMonthName">חודש</span>
            <span class="year" id="topMonthYear"></span>
          </div>

          
          <!-- WORK TABLE -->
<div style="margin-top:8px;">
            <table class="top workTable">
              <thead>
                <tr>
                  <th style="width:44%;"><div class="thFlex"><span>משימות בעבודה</span><div class="qcHdrTools">  <button class="fmtBtn fmtBold" type="button" title="Bold" aria-label="Bold">    <svg viewBox="0 0 24 24"><path d="M7 5h6.2a4.2 4.2 0 0 1 0 8.4H7V5zm6 6.5a2.3 2.3 0 0 0 0-4.6H9v4.6h4zM7 13h6.6a4.4 4.4 0 1 1 0 8.8H7V13zm6.3 6.8a2.4 2.4 0 1 0 0-4.8H9v4.8h4.3z"/></svg>  </button>  <button class="fmtBtn fmtUnderline" type="button" title="Underline" aria-label="Underline">    <svg viewBox="0 0 24 24"><path d="M7 4v7a5 5 0 0 0 10 0V4h-2v7a3 3 0 0 1-6 0V4H7zM5 20v-2h14v2H5z"/></svg>  </button>  <button class="fmtBtn fmtRed" type="button" title="Red" aria-label="Red">    <svg viewBox="0 0 24 24"><path d="M12 5l4.5 12h-2.2l-1-2.8H10.7l-1 2.8H7.5L12 5zm.7 7.4L12 10.3l-.7 2.1h1.4z"/><path d="M4 19h16v2H4z"/></svg>  </button>  <button class="fmtBtn fmtMarker" type="button" title="Marker" aria-label="Marker">    <svg viewBox="0 0 24 24" aria-hidden="true">
  <!-- pencil body -->
  <path d="M3 17.25V21h3.75L17.8 9.95l-3.75-3.75L3 17.25z"/>
  <path d="M20.7 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
  <!-- yellow marker stroke near tip -->
  <rect x="2.8" y="21.2" width="10.5" height="2.2" rx="1.1" style="fill:#ffeb3b;stroke:none"/>
</svg>  </button>  <button class="fmtBtn fmtClear" type="button" title="Clear" aria-label="Clear">    <svg viewBox="0 0 24 24"><path d="M16 9l-1.4-1.4-2.6 2.6-2.6-2.6L8 9l2.6 2.6L8 14.2l1.4 1.4 2.6-2.6 2.6 2.6 1.4-1.4-2.6-2.6L16 9z"/><path d="M4 20h16v2H4z"/></svg>  </button></div></div></th>
                  <th style="width:12%;">דחיפות</th>
                  <th style="width:14%;">בחירת יום</th>
                  <th style="width:160px;">שעה</th>
                  <th style="width:220px;">פעולות</th>
                </tr>
              </thead>
              <tbody id="brainBodyWork"></tbody>
            </table>

            <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
              <button id="addBrainWork" class="primary" type="button">הוסף שורה</button>
              <div class="small">טיפ: השורות מסודרות אוטומטית לפי דחיפות (היום, השבוע, החודש).</div>
            </div>
          </div>

          <div class="hr"></div>

          <!-- PERSONAL TABLE -->
<div style="margin-top:8px;">
            <table class="top personalTable">
              <thead>
                <tr>
                  <th style="width:44%;"><div class="thFlex"><span>משימות אישיות</span></div></th>
                  <th style="width:12%;">דחיפות</th>
                  <th style="width:14%;">בחירת יום</th>
                  <th style="width:160px;">שעה</th>
                  <th style="width:220px;">פעולות</th>
                </tr>
              </thead>
              <tbody id="brainBodyPersonal"></tbody>
            </table>

            <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
              <button id="addBrainPersonal" class="primary" type="button">הוסף שורה</button>
              <div class="small">רשימה נפרדת מהעבודה. הסידור לפי דחיפות נשאר.</div>
            </div>
          </div>

        </div>

        <div class="card">
          <div class="weekNav">
  <button class="wBtn" id="prevWeek" type="button">▶</button>
  <button class="wBtn" id="btnWeekToday" type="button">היום</button>
  <div class="weekTitle">
    <div class="weekTitleMain">תכנון שבועי</div>
    <div class="weekTitleSub" id="weekRangeLabel"></div>
</div>
  <button class="wBtn" id="nextWeek" type="button">◀</button>
  <button class="wBtn" id="btnMonthView" type="button">חודש</button>
  <input class="wDate" id="weekPick" type="date" />
</div>

          <div style="margin-top:8px;">
            <table class="week2">
              <thead>
                <tr id="weekHeadRow"></tr>
              </thead>
              <tbody id="weekBody"></tbody>
            </table>
          </div>

          <div class="hr"></div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="addWeekRow" class="primary" type="button">הוסף שורה</button>
            </div>
        </div>
      </div>

      <!-- SIDE -->
      <div class="side">
        <div class="card">
          <h2>תזכורת ל-WhatsApp</h2>

          <div style="margin-top:8px;">
            <textarea id="waText" placeholder='לדוגמה: ביטוח'></textarea>
          </div>

          <div style="margin-top:8px;">
            <input id="waTime" type="time" step="900">
          </div>

          <div style="margin-top:8px;">
            <button id="sendWa" class="primary" type="button">פתח הודעה ל-COCO</button>
          </div>
        </div>

        <div class="card">
          <h2>שבוע הבא</h2>
          <div class="hr"></div>
          <div id="queueBox" class="small"></div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button id="clearQueue" type="button">נקה</button>
          </div>
        </div>

        <div class="card">
          <h2>ארכיון</h2>
          <div id="archive"></div>
        </div>

        <div class="card sideNotes">
          <h2>הערות</h2>
          <div style="margin-top:8px;">
            <textarea id="notesText" placeholder="כתבי כאן הערות..."></textarea>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>

/* =========================
   AUTH (Supabase)
   ========================= */

/*
  כדי לעבוד "אותו משתמש מכל מקום" צריך בסיס נתונים והתחברות.
  כאן זה עובד עם Supabase Auth + טבלה אחת ששומרת את מצב האפליקציה למשתמש.

  מה עושים ב-Supabase (חד פעמי):
  1) פתחי Project
  2) Auth -> Providers -> Email: ON
  3) Database -> SQL Editor: הריצי:

  create table if not exists public.qc_states (
    user_id uuid primary key,
    state_json jsonb not null,
    updated_at timestamptz not null default now()
  );

  alter table public.qc_states enable row level security;

  create policy "Users can read own state"
  on public.qc_states for select
  using (auth.uid() = user_id);

  create policy "Users can upsert own state"
  on public.qc_states for insert
  with check (auth.uid() = user_id);

  create policy "Users can update own state"
  on public.qc_states for update
  using (auth.uid() = user_id);

  ואז הדביקי כאן את ה-URL וה-ANON KEY.
*/

const SUPABASE_URL = "https://xbvxjyiatcpvdcmakxwz.supabase.co";      // <- להדביק מ-Supabase: Project Settings -> API -> Project URL
const SUPABASE_ANON_KEY = "sb_publishable_k8Drp1fN_c3509HkTyAKKw_ETsiUgZS"; // <- להדביק מ-Supabase: Project Settings -> API -> anon public

const KEY_AUTH = "qc_auth_e27_6ux"; // מצב UI מקומי (לא חובה)
let sb = null;
let sbReady = false;
let lastUserId = null;

function $(id){ return document.getElementById(id); }

function showApp(){
  $("loginWrap").style.display = "none";
  $("appWrap").style.display = "block";
  try{ $("daypartCard").style.display = "block"; }catch(e){}
  if($("err")) $("err").style.display = "none";
}
function showLogin(){
  $("appWrap").style.display = "none";
  $("loginWrap").style.display = "flex";
  try{ $("daypartCard").style.display = "none"; }catch(e){}
  if($("err")) $("err").style.display = "none";
}
function setWhoAmI(email){
  try{
    const el = $("whoami");
    if(!el) return;
    el.textContent = email ? ("מחובר/ת: " + email) : "";
  }catch(e){}
}

function setErr(msg){
  const el = $("err");
  if(!el) return;
  el.textContent = msg || "שגיאה";
  el.style.display = "block";
}

function initSupabase(){
  try{
    if(typeof supabase === "undefined") return false;
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY) return false;

    // Safety check: Supabase anon key is usually a long JWT string (starts with "eyJ").
    // If a wrong key was pasted (often starts with "sb_"), auth and data won't work across devices.
    const k = String(SUPABASE_ANON_KEY || "").trim();
    if(k.startsWith("sb_")){
      sbReady = false;
      sb = null;
      return false;
    }

    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        // Unique key so it won't clash with other Supabase projects on the same domain
        storageKey: "qc_sb_auth_e27_6ux",
        storage: window.localStorage
      }
    });
    sbReady = true;
    return true;
  }catch(e){
    sbReady = false;
    sb = null;
    return false;
  }
}

let authMode = "login"; // login | signup
function setAuthMode(mode){
  authMode = (mode === "signup") ? "signup" : "login";
  const pill = $("authModePill");
  const btn = $("btnLogin");
  const toggle = $("btnToggleMode");
  const pw2 = $("pw2");
  const pw2Label = $("pw2Label");

  if(pill) pill.textContent = (authMode === "login") ? "כניסה" : "הרשמה";
  if(btn) btn.textContent = (authMode === "login") ? "היכנסי" : "הירשמי";
  if(toggle) toggle.textContent = (authMode === "login") ? "אין לי משתמש - הרשמה" : "יש לי משתמש - כניסה";

  const showPw2 = (authMode === "signup");
  if(pw2) pw2.style.display = showPw2 ? "block" : "none";
  if(pw2Label) pw2Label.style.display = showPw2 ? "block" : "none";

  if($("err")) $("err").style.display = "none";
}

async function sbGetUser(){
  if(!sbReady) return null;
  const { data } = await sb.auth.getUser();
  return data && data.user ? data.user : null;
}

async function cloudLoadToLocal(){
  if(!sbReady) return;

  try{
    const user = await sbGetUser();
    if(!user){
      setCloudState("ענן: לא מחובר", "warn");
      return;
    }

    setCloudState("ענן: טוען...", "warn");
    const { data, error } = await sb
      .from("qc_states")
      .select("state_json")
      .eq("user_id", user.id)
      .maybeSingle();

    if(error){
      console.error("Supabase load error:", error);
      setCloudState("ענן: שגיאה בטעינה", "err");
      return;
    }

    if(data && data.state_json){
      try{ localStorage.setItem(storageKey(), JSON.stringify(data.state_json)); }catch(e){}
      setCloudState("ענן: נטען", "ok");
    } else {
      const initial = def();
      try{ localStorage.setItem(storageKey(), JSON.stringify(initial)); }catch(e){}
      await cloudSaveNow();
      setCloudState("ענן: נוצר פרופיל חדש", "ok");
    }
  }catch(err){
    console.error("Cloud load exception:", err);
    setCloudState("ענן: שגיאה", "err");
  }
}

let cloudSaveTimer = null;
async function cloudSaveNow(){
  if(!sbReady) return;
  try{
    const user = await sbGetUser();
    if(!user){
      setCloudState("ענן: לא מחובר", "warn");
      return;
    }

    let payload = null;
    try{ payload = JSON.parse(localStorage.getItem(storageKey()) || "null"); }catch(e){ payload = null; }
    if(!payload){
      setCloudState("ענן: אין נתונים לשמירה", "warn");
      return;
    }

    const { error } = await sb.from("qc_states").upsert({
      user_id: user.id,
      state_json: payload,
      updated_at: new Date().toISOString()
    });

    if(error){
      console.error("Supabase upsert error:", error);
      setCloudState("ענן: שגיאה בשמירה", "err");
    }else{
      setCloudState("ענן: נשמר", "ok");
    }
  }catch(err){
    console.error("Cloud save exception:", err);
    setCloudState("ענן: שגיאה", "err");
  }
}

function scheduleCloudSave(){
  if(!sbReady) return;
  setCloudState("ענן: שומר...", "warn");
  clearTimeout(cloudSaveTimer);
  cloudSaveTimer = setTimeout(()=>{ cloudSaveNow(); }, 700);
}

async function doAuth(){
  const email = String($("email")?.value || "").trim();
  const pw = String($("pw")?.value || "").trim();
  const pw2 = String($("pw2")?.value || "").trim();

  if(!email || !email.includes("@")){ setErr("נא להזין אימייל תקין"); return; }
  if(pw.length < 6){ setErr("סיסמה חייבת להיות לפחות 6 תווים"); return; }
  if(authMode === "signup" && pw !== pw2){ setErr("הסיסמאות לא תואמות"); return; }

  if(!sbReady){
    localStorage.setItem(KEY_AUTH, "1");
    showApp();
    initAppOnce();
    return;
  }

  try{
    if(authMode === "login"){
      const { error } = await sb.auth.signInWithPassword({ email, password: pw });
      if(error) throw error;
    } else {
      const { error } = await sb.auth.signUp({ email, password: pw });
      if(error) throw error;
      setErr("נרשמת בהצלחה. אם נדרש אימות מייל - בדקי את תיבת הדואר ואז היכנסי.");
      setAuthMode("login");
      return;
    }
  }catch(e){
    setErr(e && e.message ? e.message : "שגיאה בהתחברות");
    return;
  }
}

async function doLogout(){
  localStorage.setItem(KEY_AUTH, "0");
  try{ localStorage.removeItem(storageKey()); }catch(e){}
  setWhoAmI("");
  if(sbReady){
    try{ await sb.auth.signOut(); }catch(e){}
  }
  showLogin();
}


function bindAuthUi(){
  $("btnLogin")?.addEventListener("click", ()=>{ doAuth(); });
  $("btnToggleMode")?.addEventListener("click", ()=>{
    setAuthMode(authMode === "login" ? "signup" : "login");
  });
  $("btnClear")?.addEventListener("click", ()=>{
    if($("email")) $("email").value = "";
    if($("pw")) $("pw").value = "";
    if($("pw2")) $("pw2").value = "";
    if($("err")) $("err").style.display = "none";
    $("email")?.focus();
  });

  ["email","pw","pw2"].forEach(id=>{
    $(id)?.addEventListener("keydown", (e)=>{ if(e.key === "Enter") doAuth(); });
  });

  $("btnLogout")?.addEventListener("click", ()=>{ doLogout(); });
}

async function initAuth(){
  initSupabase();
  bindAuthUi();
  setAuthMode("login");

  if(sbReady){
    sb.auth.onAuthStateChange(async (_event, session)=>{
      if(session && session.user){
        try{
          if(lastUserId && lastUserId !== session.user.id){
            // Legacy cleanup: older versions used a shared local key (no user suffix)
            try{ localStorage.removeItem(KEY_BASE); }catch(e){}
          }
        }catch(e){}
        _qcUserId = session.user.id;
        lastUserId = session.user.id;
        setWhoAmI(session.user.email);
        await cloudLoadToLocal();
        showApp();
        initAppOnce();
      } else {
        lastUserId = null;
        setWhoAmI("");
        showLogin();
      }
    });

    const { data } = await sb.auth.getSession();
    if(data && data.session && data.session.user){
      try{ localStorage.removeItem(KEY_BASE); }catch(e){}
      lastUserId = data.session.user.id;
      setWhoAmI(data.session.user.email);
      await cloudLoadToLocal();
      showApp();
      initAppOnce();
    } else {
      lastUserId = null;
      setWhoAmI("");
      showLogin();
    }
  } else {
    setErr("Supabase לא מוגדר או שה-ANON KEY לא תקין. כרגע זה יעבוד רק על אותו דפדפן. כדי לפתוח מכל מקום - הדביקי SUPABASE_URL + SUPABASE_ANON_KEY (ה-ANON KEY בדרך כלל מתחיל ב-eyJ...).");
    showLogin();
  }
}


/* =========================
   APP DATA + HELPERS
   ========================= */
const URGENCY = ["היום","השבוע","החודש"];
const DAYS = ["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];
const COCO_NUMBER = "12405054050";
const KEY_BASE = "quietcontrol_e27_6ux";
let _qcUserId = null; // set after login

function storageKey(userId){
  const uid = userId || _qcUserId || "anon";
  return KEY_BASE + "::" + uid;
}


const HEB_MONTHS = ["ינואר","פברואר","מרץ","אפריל","מאי","יוני","יולי","אוגוסט","ספטמבר","אוקטובר","נובמבר","דצמבר"];

function uid(){ return "t_" + Math.random().toString(36).slice(2) + Date.now().toString(36); }

function esc(x){
  return String(x ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}


function plainTextFromHtml(html){
  try{
    const d = document.createElement("div");
    d.innerHTML = String(html || "");
    return (d.innerText || d.textContent || "").trim();
  }catch(e){ return String(html||"").trim(); }
}

function sanitizeTaskHtml(raw){
  try{
    const tmp = document.createElement("div");
    tmp.innerHTML = String(raw || "");
    tmp.querySelectorAll("script, style, iframe, object, embed").forEach(n=>n.remove());

    const allowed = new Set(["B","STRONG","U","SPAN","BR","DIV"]);
    const walker = document.createTreeWalker(tmp, NodeFilter.SHOW_ELEMENT, null);
    const toClean = [];
    while(walker.nextNode()) toClean.push(walker.currentNode);

    toClean.forEach(el=>{
      if(!allowed.has(el.tagName)){
        const parent = el.parentNode;
        while(el.firstChild) parent.insertBefore(el.firstChild, el);
        parent.removeChild(el);
        return;
      }
      [...el.attributes].forEach(a=>{
        const name = a.name.toLowerCase();
        if(el.tagName === "SPAN" && name === "style"){
          const style = el.getAttribute("style") || "";
          const keep = [];
          style.split(";").forEach(part=>{
            const p = part.trim();
            if(!p) return;
            const kv = p.split(":");
            if(kv.length < 2) return;
            const k = kv[0].trim().toLowerCase();
            const v = kv.slice(1).join(":").trim();
            if(["color","background-color","font-weight","text-decoration"].includes(k)){
              keep.push(k + ":" + v);
            }
          });
          if(keep.length) el.setAttribute("style", keep.join(";"));
          else el.removeAttribute("style");
        } else {
          el.removeAttribute(a.name);
        }
      });
    });

    return tmp.innerHTML;
  }catch(e){
    return String(raw || "");
  }
}
function nowInIsrael(){
  return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Jerusalem" }));
}
function israelDayIndex(){ return nowInIsrael().getDay(); }
function pad2(n){ return String(n).padStart(2,"0"); }
function formatDDMM(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}`; }

function updateTopMonthTitle(){
  const d = nowInIsrael();
  const name = HEB_MONTHS[d.getMonth()] || "חודש";
  const year = String(d.getFullYear());
  $("topMonthName").textContent = name;
  $("topMonthYear").textContent = year;
}

// ===== Week storage (Israel: week starts Sunday) =====
function isoFromDate(d){
  const y=d.getFullYear(), m=pad2(d.getMonth()+1), da=pad2(d.getDate());
  return `${y}-${m}-${da}`;
}
function dateFromIso(iso){
  const [y,m,d]=iso.split("-").map(Number);
  return new Date(y, (m||1)-1, d||1);
}
function addDaysIso(iso, days){
  const d = dateFromIso(iso);
  d.setDate(d.getDate()+days);
  return isoFromDate(d);
}
function weekStartSundayIso(anyIso){
  const d = dateFromIso(anyIso);
  const jsDay = d.getDay(); // 0 = Sunday
  d.setDate(d.getDate() - jsDay);
  return isoFromDate(d);
}
function todayIso(){ return isoFromDate(new Date()); }
function formatWeekRange(startIso){
  const endIso = addDaysIso(startIso, 6);
  const a = formatDDMM(dateFromIso(startIso));
  const b = formatDDMM(dateFromIso(endIso));
  return `${a}-${b}`;
}

function ensureWeekStore(){
  if(!s.weeksByStart) s.weeksByStart = {};
  if(!s.currentWeekStart) s.currentWeekStart = weekStartSundayIso(todayIso());

  // migrate legacy single-week into store (one-time)
  if(s.week && !s.weeksByStart[s.currentWeekStart]){
    s.weeksByStart[s.currentWeekStart] = { rowCount: s.weekRowCount || 4, week: s.week };
  }
}

function loadWeek(startIso){
  ensureWeekStore();
  const key = startIso;
  if(!s.weeksByStart[key]){
    const rowCount = s.weekRowCount || 4;
    const week = DAYS.map((d)=>({d, rows:Array.from({length:rowCount}, ()=>({text:"",status:"none",brainId:null,manual:true}))}));
    s.weeksByStart[key] = { rowCount, week };
  }
  const pack = s.weeksByStart[key];
  s.weekRowCount = pack.rowCount || s.weekRowCount || 4;
  s.week = pack.week;
}

function saveWeek(startIso){
  ensureWeekStore();
  s.weeksByStart[startIso] = { rowCount: s.weekRowCount || 4, week: s.week };
}

function setCurrentWeek(startIso){
  ensureWeekStore();
  saveWeek(s.currentWeekStart);
  s.currentWeekStart = startIso;
  loadWeek(startIso);
  markDirty(); save(false);
}

function weekStartSundayIsrael(){
  const d = nowInIsrael();
  const day = d.getDay();
  const start = new Date(d);
  start.setHours(0,0,0,0);
  start.setDate(start.getDate() - day);
  return start;
}
function dateForDayIndex(di){
  ensureWeekStore();
  const startIso = s.currentWeekStart || weekStartSundayIso(todayIso());
  return dateFromIso(addDaysIso(startIso, di));
}
function dayLabelWithDate(dayName){
  const di = DAYS.indexOf(dayName);
  if(di < 0) return dayName;
  return `${dayName} (${formatDDMM(dateForDayIndex(di))})`;
}

function isoDateKey(d){
  const y = d.getFullYear();
  const m = pad2(d.getMonth()+1);
  const da = pad2(d.getDate());
  return `${y}-${m}-${da}`;
}
function currentWeekKey(){
  return isoDateKey(weekStartSundayIsrael());
}

function autoRolloverWeekIfNeeded(){
  const wk = currentWeekKey();
  if(!s.lastWeekStart){
    s.lastWeekStart = wk;
    markDirty(); save(false);
    return;
  }
  if(s.lastWeekStart === wk) return;

  // Week changed - clear weekly matrix for the new week
  ensureWeekMatrix();
  for(let di=0; di<7; di++){
    for(let ri=0; ri<s.weekRowCount; ri++){
      s.week[di].rows[ri] = {text:"", status:"none", brainId:null, manual:false};
    }
  }

  // Anything queued becomes "היום" too (both lists)
  const rolloverQueue = (brainArr, queueArr)=>{
    (queueArr||[]).forEach(id=>{
      const br = brainArr.find(x=>x.id===id);
      if(br){
        br.u = "היום";
        br.day = "";
        br.time = "";
        br.mdate = "";
        br.assigned = null;
      }
    });
  };
  rolloverQueue(s.brainWork, s.queueWork);
  rolloverQueue(s.brainPersonal, s.queuePersonal);
  s.queueWork = [];
  s.queuePersonal = [];

  s.lastWeekStart = wk;
  markDirty(); save(false);
}

function topicFromText(t){
  const s = (t||"").trim();
  if(!s) return "";
  const parts = s.split(/\s+/).filter(Boolean);
  return parts[0] || "";
}
function roundToNextFullQuarter(){
  const d = nowInIsrael();
  const m = d.getMinutes();
  const next = Math.ceil((m+1)/15)*15;
  d.setSeconds(0,0);
  if(next >= 60){
    d.setMinutes(0);
    d.setHours(d.getHours()+1);
  } else {
    d.setMinutes(next);
  }
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

/* =========================
   STATE
   ========================= */
const MIN_TOP_ROWS = 3;

function makeDefaultBrainRows(){
  return Array.from({length:3},(_,idx)=>({
    id:uid(),
    t:"",
    u:"השבוע",
    day:"",
    time:"",
    mdate:"",
    assigned:null,
    important:false,
    order: idx
  }));
}

function def(){
  const rows = makeDefaultBrainRows();
  return{
    notes:"",
    lastWeekStart:"",
    // Two top lists
    brainWork: rows,
    brainPersonal: makeDefaultBrainRows(),
    // Two queues (shown together in sidebar)
    queueWork:[],
    queuePersonal:[],
    visWork: MIN_TOP_ROWS,
    visPersonal: MIN_TOP_ROWS,
    weekRowCount:3,
    week: DAYS.map(d=>({ d, rows:[] })),
    archive:[]
  };
}

let s = null;
let dirty = false;
let appInited = false;

function markDirty(){ dirty = true; }

let saveTimer = null;
function flashSaved(){
  const el = $("saveState");
  if(el){
    el.style.display = "block";
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{ el.style.display = "none"; }, 1200);
  }
}

function setCloudState(text, kind){
  const el = $("cloudState");
  if(!el) return;
  el.style.display = "block";
  el.textContent = text;
  // kind: ok | warn | err
  if(kind === "err") el.style.color = "#a40000";
  else if(kind === "warn") el.style.color = "#8a5a00";
  else el.style.color = "#0f5555";
}


function save(showToast=false){
  try{ localStorage.setItem(storageKey(), JSON.stringify(s)); }catch(e){}
  dirty = false;
  if(showToast) flashSaved();
  // Cloud: persist per-user to Supabase (debounced)
  try{ if(sbReady && _qcUserId){ scheduleCloudSave(); } }catch(e){}
}


function ensureWeekMatrix(){
  s.week = DAYS.map((d,di)=>{
    const existing = (s.week && s.week[di] && s.week[di].rows) ? s.week[di].rows : [];
    const rows = [];
    for(let ri=0; ri<s.weekRowCount; ri++){
      const cell = existing[ri] || {text:"", status:"none", brainId:null, manual:false};
      rows.push({
        text: String(cell.text ?? ""),
        status: ["none","done","notdone"].includes(cell.status) ? cell.status : "none",
        brainId: cell.brainId ?? null,
        manual: !!cell.manual
      });
    }
    return {d, rows};
  });
}

function normalizeBrainList(arr){
  if(!Array.isArray(arr)) arr = makeDefaultBrainRows();

  while(arr.length < MIN_TOP_ROWS){
    arr.push({id:uid(), t:"", u:"השבוע", day:"", time:"", mdate:"", assigned:null,
    important:false, order:arr.length});
  }

  return arr.map((r, idx)=>({
    id: r?.id || uid(),
    t: String(r?.t ?? ""),
    u: URGENCY.includes(r?.u) ? r.u : "השבוע",
    day: DAYS.includes(r?.day) ? r.day : "",
    time: String(r?.time ?? ""),
    mdate: (typeof r?.mdate==="string" && /^\d{4}-\d{2}-\d{2}$/.test(r.mdate)) ? r.mdate : "",
    assigned: (r?.assigned && Number.isInteger(r.assigned.di) && Number.isInteger(r.assigned.ri)) ? r.assigned : null,
    important: !!r?.important,
    order: Number.isFinite(r?.order) ? r.order : idx
  }));
}

function normalize(){
  s = JSON.parse(localStorage.getItem(storageKey())) || def();

  // Migration from older single top-list version:
  if(Array.isArray(s.brain) && !Array.isArray(s.brainWork)){
    s.brainWork = s.brain;
  }
  if(Array.isArray(s.queue) && !Array.isArray(s.queueWork)){
    s.queueWork = s.queue;
  }

  if(typeof s.notes !== "string") s.notes = "";

  s.brainWork = normalizeBrainList(s.brainWork);
  s.brainPersonal = normalizeBrainList(s.brainPersonal);

  function maxNonEmptyIndex(arr){
    let max = -1;
    for(let i=0;i<arr.length;i++){
      if(String(arr[i]?.t ?? "").trim()) max = i;
    }
    return max;
  }

  // Visible rows: default 3. If user previously filled rows beyond 3, show them.
  if(!Number.isInteger(s.visWork) || s.visWork < MIN_TOP_ROWS) s.visWork = MIN_TOP_ROWS;
  if(!Number.isInteger(s.visPersonal) || s.visPersonal < MIN_TOP_ROWS) s.visPersonal = MIN_TOP_ROWS;

  const needWork = Math.max(MIN_TOP_ROWS, maxNonEmptyIndex(s.brainWork) + 1);
  const needPersonal = Math.max(MIN_TOP_ROWS, maxNonEmptyIndex(s.brainPersonal) + 1);

  // If visibility was never set (or is just default), keep it at 3 unless needed to reveal filled rows.
  s.visWork = Math.max(MIN_TOP_ROWS, Math.min(Math.max(s.visWork, needWork), s.brainWork.length));
  s.visPersonal = Math.max(MIN_TOP_ROWS, Math.min(Math.max(s.visPersonal, needPersonal), s.brainPersonal.length));

  if(!Number.isInteger(s.weekRowCount) || s.weekRowCount < 3) s.weekRowCount = 3;

  if(!Array.isArray(s.queueWork)) s.queueWork = [];
  if(!Array.isArray(s.queuePersonal)) s.queuePersonal = [];
  s.queueWork = s.queueWork.map(String).filter(Boolean);
  s.queuePersonal = s.queuePersonal.map(String).filter(Boolean);

  if(!Array.isArray(s.archive)) s.archive = [];

  ensureWeekMatrix();
  save(false);
}

function urgencyRank(u){
  if(u === "היום") return 0;
  if(u === "השבוע") return 1;
  return 2; // החודש
}

function brainSorted(arr){
  return [...arr].sort((a,b)=>{
    const ra = urgencyRank(a.u);
    const rb = urgencyRank(b.u);
    if(ra !== rb) return ra - rb;
    return (a.order ?? 0) - (b.order ?? 0);
  });
}

function rowClassByUrgency(u){
  if(u==="היום") return "uTodayRow";
  if(u==="השבוע") return "uWeekRow";
  return "uMonthRow";
}

function buildDayOptions(selected){
  const none = `<option value="">(ללא)</option>`;
  const opts = DAYS.map(d=>{
    const label = dayLabelWithDate(d);
    return `<option value="${esc(d)}" ${d===selected?"selected":""}>${esc(label)}</option>`;
  }).join("");
  return none + opts;
}

/* =========================
   WhatsApp
   ========================= */
function buildWhatsAppMsg(br){
  const text=plainTextFromHtml(br.t||"");
  if(!text) return "";
  let dayName = br.day;
  if(br.u==="היום") dayName = DAYS[israelDayIndex()];
  let when = "";
  if(dayName) when += ` ביום ${dayLabelWithDate(dayName)}`;
  if(br.time) when += ` בשעה ${br.time}`;
  return `תזכיר לי "${text}"${when}`;
}

function openWhatsAppToCoco(message){
  window.open(`https://wa.me/${COCO_NUMBER}?text=${encodeURIComponent(message)}`,"_blank");
}

/* =========================
   RENDER - TOP TABLES
   ========================= */
function renderBrainTable(kind){
  updateTopMonthTitle();

  const isWork = kind === "work";
  const arr = isWork ? s.brainWork : s.brainPersonal;
  const body = isWork ? $("brainBodyWork") : $("brainBodyPersonal");
  body.innerHTML = "";

  const sortedAll = brainSorted(arr);
  const visible = isWork ? (s.visWork || MIN_TOP_ROWS) : (s.visPersonal || MIN_TOP_ROWS);
  const sorted = sortedAll.slice(0, Math.max(MIN_TOP_ROWS, visible));

  sorted.forEach((r)=>{
    const tr = document.createElement("tr");
    tr.className = `brRow ${rowClassByUrgency(r.u)}`;
    tr.setAttribute("data-id", r.id);

    const dayOptions = buildDayOptions(r.day);

    tr.innerHTML = `
      <td class="taskCell"><div class="taskText" contenteditable="true" spellcheck="false" data-placeholder="רעיונות / משימות..."></div></td>
      <td>
        <select class="urgSel">
          ${URGENCY.map(o=>`<option ${o===r.u?"selected":""}>${o}</option>`).join("")}
        </select>
      </td>
      <td>
        ${
          r.u==="היום"
            ? `<div style="font-weight:900;font-family:var(--fontHead);">${esc(dayLabelWithDate(DAYS[israelDayIndex()]))}</div>`
            : (r.u==="החודש"
                ? `<input class="dateInp" type="date" value="${esc(r.mdate||"")}" />`
                : `<select class="daySel">${dayOptions}</select>`
              )
        }
      </td>
      <td>
        <input class="timeInp" type="time" step="900" value="${esc(r.time||"")}" />
      </td>
      <td class="brainActions">
        <button class="btnStar iconBtn" type="button" title="חשוב">☆</button>
        <button class="btnOk btnDone iconBtn" type="button" title="טופל">✓</button>
        <button class="btnWA iconBtn" type="button" title="WhatsApp">
  <svg width="14" height="14" viewBox="0 0 32 32" aria-hidden="true">
    <path fill="#25D366" d="M19.11 17.44c-.27-.14-1.58-.78-1.83-.87-.25-.09-.43-.14-.61.14-.18.27-.7.87-.86 1.05-.16.18-.32.2-.59.07-.27-.14-1.13-.42-2.15-1.33-.79-.7-1.33-1.56-1.49-1.83-.16-.27-.02-.42.12-.56.12-.12.27-.32.41-.48.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.48-.07-.14-.61-1.48-.84-2.03-.22-.53-.45-.46-.61-.47h-.52c-.18 0-.48.07-.73.34-.25.27-.96.94-.96 2.29s.99 2.66 1.13 2.84c.14.18 1.95 2.98 4.73 4.18.66.29 1.17.46 1.57.59.66.21 1.26.18 1.73.11.53-.08 1.58-.65 1.8-1.28.22-.63.22-1.17.16-1.28-.07-.11-.25-.18-.52-.32z"/>
    <path fill="#25D366" d="M16 3C8.83 3 3 8.83 3 16c0 2.82.93 5.43 2.5 7.55L4 29l5.6-1.47A12.9 12.9 0 0 0 16 29c7.17 0 13-5.83 13-13S23.17 3 16 3zm0 23.6c-2.39 0-4.61-.7-6.48-1.91l-.46-.29-3.32.87.89-3.24-.3-.5A10.6 10.6 0 0 1 5.4 16C5.4 10.38 10.38 5.4 16 5.4S26.6 10.38 26.6 16 21.62 26.6 16 26.6z"/>
  </svg>
</button>
        <button class="btnReset iconBtn" type="button" title="אפס">↺</button>
        <button class="btnDanger btnDel iconBtn" type="button" title="מחק">🗑</button>
      </td>
    `;

    const ta = tr.querySelector(".taskText");

    // Block drag gestures inside the task editor
    ta.setAttribute("draggable","false");
    ta.addEventListener("dragstart", (e)=>{ e.preventDefault(); e.stopPropagation(); });

    const selU = tr.querySelector(".urgSel");
    const selDay = tr.querySelector(".daySel");
    const dateInp = tr.querySelector(".dateInp");
    const timeInp = tr.querySelector(".timeInp");
    const btnStar = tr.querySelector(".btnStar");
    const btnDone = tr.querySelector(".btnDone");
    const btnWA = tr.querySelector(".btnWA");
    const btnReset = tr.querySelector(".btnReset");
    const btnDel = tr.querySelector(".btnDel");

    // init editor content (preserve plain text as text, keep HTML if exists)
    if(r.t && String(r.t).includes("<")){
      ta.innerHTML = String(r.t);
    } else {
      ta.textContent = String(r.t || "");
    }

    // track last focused editor so header toolbar applies
    ta.addEventListener("focus", ()=>{ window.__qcActiveTaskEditor = ta; });

    let __qcDebounce = null;
    const __qcSync = (sanitize=false)=>{
      const raw = ta.innerHTML;
      r.t = sanitize ? sanitizeTaskHtml(raw) : raw;
      markDirty(); save(false);
      renderQueue();
    };

    ta.addEventListener("input", ()=>{
      clearTimeout(__qcDebounce);
      __qcDebounce = setTimeout(()=>__qcSync(false), 220);
    });
    ta.addEventListener("blur", ()=>{
      const clean = sanitizeTaskHtml(ta.innerHTML);
      if(clean !== ta.innerHTML) ta.innerHTML = clean;
      __qcSync(true);
    });

    selU.onchange = (e)=>{
      r.u = e.target.value;

      if(r.u === "היום"){
        r.day = "";
        r.mdate = "";
      } else if(r.u === "השבוע"){
        r.mdate = "";
      } else if(r.u === "החודש"){
        r.day = "";
      }

      markDirty(); save(false);
      renderBrainTable(kind);
    };

    if (selDay) {
      selDay.onchange = (e) => {
        r.day = e.target.value || "";
        markDirty(); save(false);
        renderBrainTable(kind);
      };
    }

    if (dateInp) {
      const onDatePicked = (e) => {
        r.mdate = (e.target.value || "").trim();
        markDirty(); save(false);
      };
      dateInp.oninput = onDatePicked;
      dateInp.onchange = onDatePicked;
    }

    timeInp.oninput = (e)=>{
      r.time = (e.target.value || "").trim();
      markDirty(); save(false);
      renderBrainTable(kind);
    };


    const refreshStarUI = ()=>{
      if(r.important){
        btnStar.classList.add("on");
        btnStar.textContent = "★";
      } else {
        btnStar.classList.remove("on");
        btnStar.textContent = "☆";
      }
    };
    refreshStarUI();

    btnStar.onclick = ()=>{
      r.important = !r.important;
      refreshStarUI();
      markDirty(); save(false);
    };

    btnDone.onclick = ()=>{
      if(!r.t.trim()) return alert("אין משימה לסמן");

      // Remove from the matching queue
      if(isWork) s.queueWork = s.queueWork.filter(x=>x!==r.id);
      else s.queuePersonal = s.queuePersonal.filter(x=>x!==r.id);

      // Remove row from the matching list
      const idx = arr.findIndex(x=>x.id===r.id);
      if(idx >= 0) arr.splice(idx, 1);

      markDirty(); save(false);
      renderBrainTable(kind);
      renderQueue();
      renderWeek();
      flashSaved();
    };

    btnWA.onclick = ()=>{
      const msg = buildWhatsAppMsg(r);
      if(!msg) return alert("אין משימה");
      openWhatsAppToCoco(msg);
    };

    btnReset.onclick = ()=>{
      r.t = "";
      r.u = "השבוע";
      r.day = "";
      r.time = "";
      r.mdate = "";
      r.assigned = null;
      r.important = false;
      markDirty(); save(false);
      renderBrainTable(kind);
      renderWeek();
      renderQueue();
    };

    btnDel.onclick = ()=>{
      if(isWork) s.queueWork = s.queueWork.filter(x=>x!==r.id);
      else s.queuePersonal = s.queuePersonal.filter(x=>x!==r.id);

      const idx = arr.findIndex(x=>x.id===r.id);
      if(idx >= 0) arr.splice(idx, 1);

      markDirty(); save(false);
      renderBrainTable(kind);
      renderWeek();
      renderQueue();
    };

    // Drag and drop within the same table, inside same urgency group
    // Make the whole row draggable, but NEVER start a drag from the task area (white editor) or its cell
    tr.draggable = true;

    const taskCell = tr.querySelector(".taskCell");
    const taskBox  = tr.querySelector(".taskText");

    // Hard-block HTML5 drag initiation on the task area itself
    if(taskCell){
      taskCell.setAttribute("draggable","false");
      taskCell.addEventListener("dragstart", (e)=>{ e.preventDefault(); e.stopPropagation(); });
    }
    if(taskBox){
      taskBox.setAttribute("draggable","false");
      taskBox.addEventListener("dragstart", (e)=>{ e.preventDefault(); e.stopPropagation(); });
    }

    // Extra safety: while interacting inside the task area, temporarily disable row dragging
    const _disableRowDrag = ()=>{ tr.draggable = false; };
    const _enableRowDrag  = ()=>{ tr.draggable = true; };

    if(taskCell){
      ["mousedown","pointerdown","touchstart"].forEach(ev=>{
        taskCell.addEventListener(ev, _disableRowDrag, {passive:true});
      });
      ["mouseup","pointerup","touchend","mouseleave","touchcancel"].forEach(ev=>{
        taskCell.addEventListener(ev, _enableRowDrag);
      });
    }
    if(taskBox){
      ["mousedown","pointerdown","touchstart","focus"].forEach(ev=>{
        taskBox.addEventListener(ev, _disableRowDrag, {passive:true});
      });
      ["mouseup","pointerup","touchend","blur"].forEach(ev=>{
        taskBox.addEventListener(ev, _enableRowDrag);
      });
    }

    tr.addEventListener("dragstart", (e)=>{
      // Do NOT allow dragging when starting from the task writing area (white box) or its cell (colored background)
      if(e.target && (e.target.closest(".taskText") || e.target.closest(".taskCell"))){
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      tr.classList.add("dragging");
      e.dataTransfer.setData("text/plain", JSON.stringify({kind, id:r.id}));
    });
    tr.addEventListener("dragend", ()=>{
      tr.classList.remove("dragging");
      Array.from(body.querySelectorAll("tr.brRow")).forEach(x=>x.classList.remove("dropHover"));
    });
    tr.addEventListener("dragover", (e)=>{
      e.preventDefault();
      tr.classList.add("dropHover");
    });
    tr.addEventListener("dragleave", ()=>{
      tr.classList.remove("dropHover");
    });
    tr.addEventListener("drop", (e)=>{
      e.preventDefault();
      tr.classList.remove("dropHover");

      const raw = e.dataTransfer.getData("text/plain");
      if(!raw) return;
      let payload=null;
      try{ payload = JSON.parse(raw); }catch(_){ return; }
      if(!payload || payload.kind !== kind) return;

      const draggedId = payload.id;
      if(!draggedId || draggedId === r.id) return;

      const dragged = arr.find(x=>x.id===draggedId);
      const target = arr.find(x=>x.id===r.id);
      if(!dragged || !target) return;

      if(dragged.u !== target.u){
        alert('כדי לשמור על סדר לפי דחיפות, גרירה עובדת בתוך אותו סוג דחיפות.');
        return;
      }

      const group = arr.filter(x=>x.u === dragged.u).sort((a,b)=>(a.order??0)-(b.order??0));
      const newList = group.filter(x=>x.id!==dragged.id);

      const targetIndex = newList.findIndex(x=>x.id===target.id);
      const insertAt = Math.max(0, targetIndex);

      newList.splice(insertAt, 0, dragged);

      newList.forEach((item, idx)=>{ item.order = idx; });

      markDirty(); save(false);
      renderBrainTable(kind);
    });

    body.appendChild(tr);
  });
}

function renderBrain(){
  renderBrainTable("work");
  renderBrainTable("personal");


  // Header formatting toolbar (Word-like) applies to the last focused task editor
  const applyToActive = (cmd, val=null)=>{
    const ed = window.__qcActiveTaskEditor;
    if(!ed) return;
    ed.focus();
    try{
      if(cmd === "hiliteColor"){
        document.execCommand("hiliteColor", false, val);
        document.execCommand("backColor", false, val);
      } else if(val !== null){
        document.execCommand(cmd, false, val);
      } else {
        document.execCommand(cmd, false, null);
      }
    }catch(e){}
    try{ ed.dispatchEvent(new Event("input")); }catch(e){}
  };
  // Stable marker (highlight) toggle for contenteditable task editors.
  // We avoid execCommand for highlight because it is inconsistent across browsers.
  const toggleMarkerOnActive = (color="#fff59d")=>{
    const ed = window.__qcActiveTaskEditor;
    if(!ed) return;
    ed.focus();

    const sel = window.getSelection && window.getSelection();
    if(!sel || sel.rangeCount === 0) return;

    const range = sel.getRangeAt(0);

    // Ensure selection/caret is inside the active editor
    const ca = range.commonAncestorContainer;
    const anchorNode = ca.nodeType === 3 ? ca.parentNode : ca;
    if(!ed.contains(anchorNode)) return;

    // Collapsed caret: if we're inside an existing highlight, remove it.
    if(range.collapsed){
      let n = sel.anchorNode;
      if(!n) return;
      if(n.nodeType === 3) n = n.parentNode;
      const sp = (n && n.closest) ? n.closest("span.qcMark") : null;
      if(sp && ed.contains(sp)){
        const parent = sp.parentNode;
        const after = sp.nextSibling;

        while(sp.firstChild) parent.insertBefore(sp.firstChild, sp);
        parent.removeChild(sp);

        // Restore caret position as close as possible
        try{
          const r = document.createRange();
          if(after){
            r.setStartBefore(after);
            r.collapse(true);
          }else{
            r.selectNodeContents(parent);
            r.collapse(false);
          }
          sel.removeAllRanges();
          sel.addRange(r);
        }catch(e){}

        ed.dispatchEvent(new Event("input", {bubbles:true}));
      }
      return;
    }

    // Non-collapsed selection: toggle off if selection intersects any highlights.
    let removed = false;
    const marks = Array.from(ed.querySelectorAll("span.qcMark"));
    for(const sp of marks){
      try{
        if(range.intersectsNode(sp)){
          const parent = sp.parentNode;
          while(sp.firstChild) parent.insertBefore(sp.firstChild, sp);
          parent.removeChild(sp);
          removed = true;
        }
      }catch(e){}
    }
    if(removed){
      ed.dispatchEvent(new Event("input", {bubbles:true}));
      return;
    }

    // Toggle on: wrap selected contents with highlight span
    const span = document.createElement("span");
    span.className = "qcMark";
    span.style.backgroundColor = color;

    const frag = range.extractContents();
    span.appendChild(frag);
    range.insertNode(span);

    // Keep selection on the newly highlighted text
    try{
      sel.removeAllRanges();
      const r = document.createRange();
      r.selectNodeContents(span);
      sel.addRange(r);
    }catch(e){}

    ed.dispatchEvent(new Event("input", {bubbles:true}));
  };



  document.querySelectorAll(".qcHdrTools .fmtBold").forEach(b=>b.addEventListener("click", ()=>applyToActive("bold")));
  document.querySelectorAll(".qcHdrTools .fmtUnderline").forEach(b=>b.addEventListener("click", ()=>applyToActive("underline")));
  document.querySelectorAll(".qcHdrTools .fmtRed").forEach(b=>b.addEventListener("click", ()=>applyToActive("foreColor", "#b00000")));
  document.querySelectorAll(".qcHdrTools .fmtMarker").forEach(b=>{
    b.addEventListener("mousedown", (e)=>{ e.preventDefault(); });
    b.addEventListener("click", ()=>toggleMarkerOnActive("#fff59d"));
  });
  document.querySelectorAll(".qcHdrTools .fmtClear").forEach(b=>b.addEventListener("click", ()=>{
    const ed = window.__qcActiveTaskEditor;
    if(!ed) return;
    ed.focus();
    try{ document.execCommand("removeFormat", false, null); }catch(e){}
    const tmp = document.createElement("div");
    tmp.innerHTML = ed.innerHTML;
    tmp.querySelectorAll("span").forEach(s=>{
      const p = s.parentNode;
      while(s.firstChild) p.insertBefore(s.firstChild, s);
      p.removeChild(s);
    });
    ed.innerHTML = tmp.innerHTML;
    try{ ed.dispatchEvent(new Event("input")); }catch(e){}
  }));

}

/* =========================
   SIDEBAR - QUEUE (kept same box, but shows both)
   ========================= */
function renderQueue(){
  const box = $("queueBox");

  const workItems = (s.queueWork||[]).map(id=>{
    const br = s.brainWork.find(x=>x.id===id);
    const txt = br ? br.t.trim() : "";
    return txt ? `• ${txt}` : "";
  }).filter(Boolean);

  const persItems = (s.queuePersonal||[]).map(id=>{
    const br = s.brainPersonal.find(x=>x.id===id);
    const txt = br ? br.t.trim() : "";
    return txt ? `• ${txt}` : "";
  }).filter(Boolean);

  if(!workItems.length && !persItems.length){
    box.textContent = "אין פריטים לשבוע הבא";
    return;
  }

  let out = "";
  if(workItems.length){
    out += "עבודה:\n" + workItems.join("\n");
  }
  if(persItems.length){
    out += (out ? "\n\n" : "") + "אישי:\n" + persItems.join("\n");
  }
  box.textContent = out;
}

/* =========================
   ARCHIVE (unchanged)
   ========================= */
function renderArchive(){
  const a = $("archive");
  a.innerHTML = "";
  if(!s.archive.length){
    a.innerHTML = `<div class="small">אין עדיין ארכיון</div>`;
    return;
  }
  s.archive.slice(0,12).forEach(item=>{
    const div = document.createElement("div");
    div.className = "archive-item";
    div.innerHTML = `<div style="font-weight:700;font-size:12px;font-family:var(--fontHead);">${esc(item.title || "שבוע")}</div>
                     <div class="small">${esc(item.date || "")}</div>`;
    div.onclick = ()=>{
      alert("בגרסה הזו הארכיון מוצג לצפייה בלבד.");
    };
    a.appendChild(div);
  });
}

/* =========================
   WEEK RENDER (same as original)
   ========================= */
function renderWeekHeader(){
  ensureWeekStore();
  const startIso = s.currentWeekStart || weekStartSundayIso(todayIso());

  const lbl = $("weekRangeLabel");
  if(lbl) lbl.textContent = formatWeekRange(startIso);

  const pick = $("weekPick");
  if(pick) pick.value = startIso;

  const tr = $("weekHeadRow");
  tr.innerHTML = "";

  for(let di=0; di<7; di++){
    const th = document.createElement("th");
    th.className="dayHead";
    const name = DAYS[di];
    const date = formatDDMM(dateForDayIndex(di));
    th.innerHTML = `${name}<span class="dayDate">${date}</span>`;
    tr.appendChild(th);
  }
}

function getCell(di, ri){ return s.week[di].rows[ri]; }
function setStatus(di, ri, st){
  const cell = getCell(di,ri);
  if(!(cell.text||"").trim()) return;
  // Requirement: if marked "done" (טופל) remove the task completely
  if(st === "done"){
    cell.text = "";
    cell.status = "none";
    cell.manual = false;
    cell.brainId = null;
    markDirty(); save(false);
    renderWeek();
    renderQueue();
    return;
  }
  cell.status = st;
  markDirty(); save(false);
}

function renderWeek(){
  renderWeekHeader();
  ensureWeekMatrix();

  const body = $("weekBody");
  body.innerHTML = "";

  for(let ri=0; ri<s.weekRowCount; ri++){
    const tr = document.createElement("tr");

    for(let di=0; di<7; di++){
      const td = document.createElement("td");
      const cell = getCell(di,ri);

      const div = document.createElement("div");
      div.className = "taskCell";

      const txt = (cell.text || "").trim();

      if(!txt){
        div.classList.add("empty");
        div.innerHTML = `<div class="pencil"></div>`;
      } else {
        div.classList.add("draggable");
        div.classList.add("hasTask");
        if(cell.status === "done") div.classList.add("done");
        if(cell.status === "notdone") div.classList.add("notdone");

        const main = document.createElement("div");
        main.className = "taskMain";

        const topic = document.createElement("div");
        topic.className = "taskTopic";
        topic.textContent = txt;

        const meta = document.createElement("div");
        meta.className = "taskMeta";
        meta.textContent = "";

        main.appendChild(topic);
        if(meta.textContent) main.appendChild(meta);
        div.appendChild(main);

        const btn = document.createElement("button");
        btn.className = "statusBtn";
        if(cell.status === "done"){ btn.classList.add("popOk"); btn.textContent="טופל"; }
        else if(cell.status === "notdone"){ btn.classList.add("popBad"); btn.textContent="לא טופל"; }
        else { btn.textContent="סטטוס"; }

        btn.onclick = (e)=>{
          e.stopPropagation();
          openStatusPopover(e.clientX, e.clientY, di, ri);
        };
        div.appendChild(btn);
      }

      div.onclick = ()=>{
        const v = prompt(`משימה ליום ${DAYS[di]}:`, txt || "");
        if(v === null) return;
        const val = String(v).trim();

        // empty input clears the cell
        if(!val){
          cell.text = "";
          cell.status = "none";
          cell.manual = false;
          cell.brainId = null;
        } else {
          cell.text = val;
          cell.status = "none";
          cell.manual = true;
          cell.brainId = null;
        }

        markDirty(); save(false);
        renderWeek();
        renderQueue();
      };

      div.draggable = !!txt;
      div.addEventListener("dragstart", (e)=>{
        if(!txt) return;
        div.classList.add("dragging");
        e.dataTransfer.setData("text/plain", JSON.stringify({fromDi:di, fromRi:ri}));
      });
      div.addEventListener("dragend", ()=>{
        div.classList.remove("dragging");
      });
      td.addEventListener("dragover", (e)=>{
        e.preventDefault();
        div.classList.add("dropHover");
      });
      td.addEventListener("dragleave", ()=>{
        div.classList.remove("dropHover");
      });
      td.addEventListener("drop", (e)=>{
        e.preventDefault();
        div.classList.remove("dropHover");
        const data = e.dataTransfer.getData("text/plain");
        if(!data) return;
        const obj = JSON.parse(data);
        const src = getCell(obj.fromDi, obj.fromRi);
        const dst = getCell(di, ri);
        if(!src.text.trim()) return;

        const tmp = {...dst};
        s.week[di].rows[ri] = {...src};
        s.week[obj.fromDi].rows[obj.fromRi] = tmp;

        markDirty(); save(false);
        renderWeek();
        renderBrain();
      });

      td.appendChild(div);
      tr.appendChild(td);
    }

    body.appendChild(tr);
  }
}

let pop = null;
function closePopover(){ if(pop){ pop.remove(); pop=null; } }
function openStatusPopover(x,y,di,ri){
  closePopover();
  pop = document.createElement("div");
  pop.className="popover";
  pop.style.left = Math.max(10, x - 180) + "px";
  pop.style.top  = Math.max(10, y + 10) + "px";
  pop.innerHTML = `
    <div class="popTitle">סטטוס משימה</div>
    <div class="popBtns">
      <button class="popOk" type="button">טופל</button>
      <button class="popBad" type="button">לא טופל</button>
    </div>
    <div class="popHint">לחצי מחוץ לחלון לסגירה</div>
  `;
  document.body.appendChild(pop);

  pop.querySelector(".popOk").onclick = ()=>{
    setStatus(di,ri,"done");
    renderWeek();
    closePopover();
  };
  pop.querySelector(".popBad").onclick = ()=>{
    setStatus(di,ri,"notdone");
    renderWeek();
    closePopover();
  };
}
document.addEventListener("click", (e)=>{
  if(pop && !pop.contains(e.target)) closePopover();
});

/* =========================
   BUTTONS / EVENTS
   ========================= */
function initAppOnce(){
  if(appInited) return;
  appInited = true;

  normalize();
  autoRolloverWeekIfNeeded();
  // Always open the current week on load (avoid opening an old week)
  setCurrentWeek(weekStartSundayIso(todayIso()));
  updateTopMonthTitle();

  $("notesText").value = s.notes;
  $("notesText").oninput = (e)=>{
    s.notes = e.target.value;
    markDirty(); save(false);
  };

  $("btnSaveNow").onclick = async ()=>{ save(true); try{ await cloudSaveNow(); }catch(e){} };

  // autosave silent every 2 minutes
  setInterval(()=>{ if(dirty) save(false); }, 120000);

  $("addBrainWork").onclick = ()=>{
    s.visWork = Math.max(MIN_TOP_ROWS, (Number.isInteger(s.visWork) ? s.visWork : MIN_TOP_ROWS) + 1);
    const maxOrder = Math.max(0, ...s.brainWork.filter(x=>x.u==="השבוע").map(x=>x.order??0));
    s.brainWork.push({id:uid(), t:"", u:"השבוע", day:"", time:"", mdate:"", assigned:null,
    important:false,
    important:false, order:maxOrder+1});
    markDirty(); save(false);
    renderBrainTable("work");
  };

  $("addBrainPersonal").onclick = ()=>{
    s.visPersonal = Math.max(MIN_TOP_ROWS, (Number.isInteger(s.visPersonal) ? s.visPersonal : MIN_TOP_ROWS) + 1);
    const maxOrder = Math.max(0, ...s.brainPersonal.filter(x=>x.u==="השבוע").map(x=>x.order??0));
    s.brainPersonal.push({id:uid(), t:"", u:"השבוע", day:"", time:"", mdate:"", assigned:null,
    important:false,
    important:false, order:maxOrder+1});
    markDirty(); save(false);
    renderBrainTable("personal");
  };

  $("addWeekRow").onclick = ()=>{
    s.weekRowCount += 1;
    ensureWeekMatrix();
    markDirty(); save(false);
    renderWeek();
  };

  $("clearQueue").onclick = ()=>{
    s.queueWork = [];
    s.queuePersonal = [];
    markDirty(); save(false);
    renderQueue();
  };

  $("waTime").value = roundToNextFullQuarter();
  $("sendWa").onclick = ()=>{
    const text = ($("waText").value || "").trim();
    if(!text) return alert("כתבי קודם טקסט");
    const t = ($("waTime").value || "").trim();
    const msg = `תזכיר לי "${text}"${t ? ` בשעה ${t}` : ""}`;
    openWhatsAppToCoco(msg);
  };

  // Week navigation (Sun-Sat)
  $("prevWeek").onclick = ()=>{ setCurrentWeek(addDaysIso(s.currentWeekStart, -7)); renderWeek(); };
  $("nextWeek").onclick = ()=>{ setCurrentWeek(addDaysIso(s.currentWeekStart,  7)); renderWeek(); };
  $("btnWeekToday").onclick = ()=>{
    setCurrentWeek(weekStartSundayIso(todayIso()));
    renderWeek();
  };
  $("weekPick").onchange = (e)=>{
    const iso = String(e.target.value||"").trim();
    if(!iso) return;
    setCurrentWeek(weekStartSundayIso(iso));
    renderWeek();
  };
  $("btnMonthView").onclick = ()=> alert("תצוגת חודש תתווסף בשלב הבא.");

  renderBrain();
  renderWeek();
  renderQueue();
  renderArchive();
}

function bindLoginEvents(){
  $("btnLogin").onclick = tryLogin;
  $("btnClear").onclick = ()=>{
    $("pw").value = "";
    $("err").style.display = "none";
    $("pw").focus();
  };
  $("btnLogout").onclick = ()=>{
    setAuthed(false);
    showLogin();
  };
  $("pw").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") tryLogin();
  });
}

/* =========================
   BOOT
   ========================= */
document.addEventListener("DOMContentLoaded", ()=>{ initAuth(); });
/* --- Weather (stable): Tel Aviv default via Open-Meteo (no permissions, no key needed) --- */
(function(){
  const LAT = 32.0853, LON = 34.7818; // Tel Aviv
  const CACHE_KEY = "qc_weather_v3";
  const CACHE_MIN = 60;
  const HEB = ["א׳","ב׳","ג׳","ד׳","ה׳","ו׳","ש׳"];

  function fmt(n){ return (n===null||n===undefined||Number.isNaN(Number(n))) ? "--" : (Math.round(Number(n))+"°"); }

  function owTypeFromMeteo(code){
    // 3 clear categories only:
    // sun: clear
    // partly: mainly clear / partly cloudy
    // cloud: everything else (cloudy, fog, rain, snow, etc.)
    if(code===0) return "sun";
    if(code===1 || code===2) return "partly";
    if(code===3) return "cloud";
    if(code===61 || code===63 || code===65 || code===80 || code===81 || code===82) return "rain";
    return "cloud";
  }

  function setMsg(msg){
    const el = document.getElementById("weatherStrip");
    if(!el) return;
    el.innerHTML = `<div class="weatherLoading">${msg}</div>`;
  }

  function render(days){
    const el = document.getElementById("weatherStrip");
    if(!el) return;
    if(!Array.isArray(days) || !days.length){ setMsg("מזג אוויר לא זמין"); return; }
    el.innerHTML = days.slice(0,7).map(d=>{
      const wType = owTypeFromMeteo(d.code);
      const svg = (wType==="sun") ? `<svg class="wIcon wSun" viewBox="0 0 64 64" aria-hidden="true">
  <defs>
    <radialGradient id="sunGrad" cx="35%" cy="35%" r="70%">
      <stop offset="0%" stop-color="#FFD45A"/>
      <stop offset="100%" stop-color="#F39A17"/>
    </radialGradient>
  </defs>
  <circle cx="32" cy="32" r="16" fill="url(#sunGrad)"/>
</svg>` : (wType==="partly") ? `<svg class="wIcon wPartly" viewBox="0 0 64 64" aria-hidden="true">
  <defs>
    <radialGradient id="sunGrad2" cx="35%" cy="35%" r="70%">
      <stop offset="0%" stop-color="#FFD45A"/>
      <stop offset="100%" stop-color="#F39A17"/>
    </radialGradient>
  </defs>
  <circle cx="26" cy="26" r="14" fill="url(#sunGrad2)"/>
  <path d="M26 50h22a10 10 0 0 0 0-20c-.6 0-1.2.05-1.8.15A14 14 0 0 0 19.5 36 8.5 8.5 0 0 0 26 50Z"
        fill="#EDEFF2"/>
  <path d="M26 50h22a10 10 0 0 0 0-20c-.6 0-1.2.05-1.8.15A14 14 0 0 0 19.5 36 8.5 8.5 0 0 0 26 50Z"
        fill="none" stroke="#D9DEE5" stroke-width="1.2"/>
</svg>` : `<svg class="wIcon wCloud" viewBox="0 0 64 64" aria-hidden="true">
  <path d="M22 46h26a12 12 0 0 0 0-24c-.7 0-1.4.06-2.1.18A16 16 0 0 0 15.7 28.5 10 10 0 0 0 22 46Z"
        fill="#B9BDC3"/>
  <path d="M22 46h26a12 12 0 0 0 0-24c-.7 0-1.4.06-2.1.18A16 16 0 0 0 15.7 28.5 10 10 0 0 0 22 46Z"
        fill="none" stroke="#AEB3B9" stroke-width="1.2" opacity="0.55"/>
</svg>`;
      return `
        <div class="weatherDay" title="מינימום-מקסימום">
          <div class="wDayName">${d.name}</div>
          ${svg}
          <div class="wTemps"><span class="wMin">${fmt(d.min)}</span><span class="wMax">${fmt(d.max)}</span></div>
        </div>
      `;
    }).join("");
  }

  function getCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.t || !obj.days) return null;
      const age = (Date.now()-obj.t)/60000;
      if(age > CACHE_MIN) return null;
      return obj.days;
    }catch(e){ return null; }
  }
  function setCache(days){
    try{ localStorage.setItem(CACHE_KEY, JSON.stringify({t:Date.now(), days})); }catch(e){}
  }

  async function fetchMeteo(){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weathercode,temperature_2m_max,temperature_2m_min&forecast_days=7&timezone=auto`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("http_"+res.status);
    return await res.json();
  }

  async function init(){
    const cached = getCache();
    if(cached){ render(cached); return; }
    setMsg("טוען מזג אוויר...");
    try{
      const om = await fetchMeteo();
      const times = om?.daily?.time || [];
      const mins  = om?.daily?.temperature_2m_min || [];
      const maxs  = om?.daily?.temperature_2m_max || [];
      const codes = om?.daily?.weathercode || [];
      const days = times.slice(0,7).map((t,i)=>{
        const d = new Date(t+"T12:00:00");
        return { name: HEB[d.getDay()], min: mins[i], max: maxs[i], code: codes[i] };
      });
      setCache(days);
      render(days);
    }catch(e){
      console.warn("weather failed", e);
      setMsg("מזג אוויר לא זמין");
    }
  }

  window.addEventListener("load", init);
})();

</script>


<script>
/* --- Mark TODAY in weather (Israel timezone) --- */
(function(){
  function markToday(){
    const heb = ["א","ב","ג","ד","ה","ו","ש"]; // Sun..Sat
    const israelNow = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Jerusalem" }));
    const todayHeb = heb[israelNow.getDay()];
    document.querySelectorAll('.weatherDay').forEach(card=>{
      const el = card.querySelector('.wDayName');
      if(!el) return;
      const first = (el.textContent || "").trim()[0];
      if(first === todayHeb){
        card.classList.add('today');
      }
    });
  }
  // run after load and again shortly after to ensure weather tiles exist
  window.addEventListener('load', ()=>{
    setTimeout(markToday, 100);
    setTimeout(markToday, 500);
  });
})();
</script>


<script>
/* --- Remove task when marked as done (all tables) --- */
(function(){
  document.addEventListener('change', function(e){
    const t = e.target;
    if(t && (t.classList.contains('done') || t.classList.contains('taskDone'))){
      const row = t.closest('tr');
      if(row) row.remove();
    }
  });
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btnDone');
    if(btn){
      const row = btn.closest('tr');
      if(row) row.remove();
    }
  });
})();
</script>


<script>
/* --- Calendar: remove item when marked done --- */
(function(){
  document.addEventListener('click', function(e){
    // handle calendar done buttons/icons
    const calDone = e.target.closest('.calendarDone, .calDone, .doneCalendar');
    if(calDone){
      const item = calDone.closest('.calendarItem, .calItem, td');
      if(item){
        // if inside td with multiple items, remove only the item; else clear cell
        if(item.classList.contains('calendarItem') || item.classList.contains('calItem')){
          item.remove();
        }else{
          item.innerHTML = '';
        }
      }
    }
  });
})();
</script>



<script>
/* --- Hide left cards: 'שבוע הבא' and 'ארכיון' --- */
(function(){
  function hideCards(){
    document.querySelectorAll('.card h2').forEach(h2=>{
      const t = (h2.textContent||'').trim();
      if(t === 'שבוע הבא' || t === 'ארכיון'){
        const card = h2.closest('.card');
        if(card) card.style.display = 'none';
      }
    });
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', hideCards);
  } else {
    hideCards();
  }
})();
</script>


<script>
/* --- Daypart buttons: toggle gold, persist --- */
(function(){
  const KEY = "qc_daypart_state_v1";
  const ids = ["btnMorning","btnNoon","btnEvening"];

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return {};
      return JSON.parse(raw) || {};
    }catch(e){ return {}; }
  }
  function save(state){
    try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){}
  }
  function apply(state){
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.classList.toggle("isOn", !!state[id]);
    });
  }

  const state = load();
  window.addEventListener("load", ()=>{
    apply(state);
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener("click", ()=>{
        state[id] = !state[id];
        save(state);
        apply(state);
      });
    });
  });
})();
</script>


<script>
/* --- Daypart: place under WhatsApp, then Notes under Daypart (no deletion) --- */
(function(){
  function findCardByHeadingContains(substr){
    const heads = Array.from(document.querySelectorAll('.card h2, h2'));
    const h = heads.find(el => ((el.textContent||'').trim()).includes(substr));
    return h ? h.closest('.card') : null;
  }
  function findCardByExact(title){
    const heads = Array.from(document.querySelectorAll('.card h2, h2'));
    const h = heads.find(el => ((el.textContent||'').trim()) === title);
    return h ? h.closest('.card') : null;
  }

  function relocate(){
    const daypart = document.getElementById('daypartCard');
    if(!daypart) return;

    const waCard = findCardByHeadingContains('WhatsApp');
    const notesCard = findCardByExact('הערות');

    if(waCard && waCard.parentElement){
      waCard.insertAdjacentElement('afterend', daypart);
    }

    if(notesCard && notesCard.parentElement){
      daypart.insertAdjacentElement('afterend', notesCard);
      // Ensure notes is visible (in case prior css hid it somewhere)
      notesCard.style.display = '';
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', relocate);
  } else {
    relocate();
  }
})();
</script>


<script>
/* --- Weekly subtitle under month title (Israel week: Sun-Sat) --- */
(function(){
  function fmt(d){
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    return dd + '.' + mm;
  }
  function israelNow(){
    return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Jerusalem" }));
  }
  function calcRange(){
    const now = israelNow();
    const day = now.getDay(); // 0=Sun
    const start = new Date(now);
    start.setDate(now.getDate() - day);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    return fmt(start) + '-' + fmt(end);
  }
  function inject(){
    const title = document.querySelector('.monthTitle');
    if(!title) return;
    let sub = title.querySelector('.weeklySub');
    if(!sub){
      sub = document.createElement('div');
      sub.className = 'weeklySub';
      sub.style.fontSize = '14px';
      sub.style.fontWeight = '700';
      sub.style.opacity = '0.72';
      sub.style.marginTop = '2px';
      sub.style.flexBasis = '100%';
      title.appendChild(sub);
    }
    sub.style.display = 'flex';
    sub.style.alignItems = 'center';
    sub.style.gap = '8px';
    sub.style.justifyContent = 'flex-start';
    sub.innerHTML = '';
    const span = document.createElement('span');
    span.className = 'weeklyLabel';
    span.textContent = 'משימות שבועי • ' + calcRange();
    const btn = document.createElement('button');
    btn.className = 'fmtBtn fmtExport qcWeekExport';
    btn.type = 'button';
    btn.title = 'יצוא לאקסל';
    btn.setAttribute('aria-label','Export Excel');
    btn.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="3" ry="3" fill="#1f8f4a"/><path d="M8 8 L16 16 M16 8 L8 16" stroke="#ffffff" stroke-width="2.6" stroke-linecap="round"/></svg>`;
    btn.addEventListener('mousedown',(e)=>{e.preventDefault();}, true);
    btn.addEventListener('click',(e)=>{e.preventDefault(); exportWorkPersonal();});
    sub.appendChild(span);
    sub.appendChild(btn);
}

  // Title is rendered by app JS; retry a few times quickly
  let tries = 0;
  function tick(){
    inject();
    tries++;
    if(!document.querySelector('.monthTitle .weeklySub') && tries < 25){
      setTimeout(tick, 80);
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', tick);
  } else {
    tick();
  }
})();
</script>


<div class="qcMonthOverlay" id="qcMonthOverlay" aria-hidden="true">
  <div class="qcMonthModal" role="dialog" aria-modal="true" aria-label="תצוגת חודש">
    <div class="qcMonthHead">
      <div class="qcMonthTitle">תצוגת חודש</div>
      <button class="qcMonthClose" id="qcMonthClose" type="button" aria-label="סגירה">✕</button>
    </div>

    <div class="qcMonthCal" dir="rtl">
      <div class="qcMonthCalHead">
        <button class="qcMonthNav" id="qcPrevMonth" type="button" aria-label="חודש קודם">‹</button>
        <div class="qcMonthCalLabel" id="qcMonthLabel">חודש</div>
        <button class="qcMonthNav" id="qcNextMonth" type="button" aria-label="חודש הבא">›</button>
      </div>

      <div class="qcMonthDow">
        <div>א</div><div>ב</div><div>ג</div><div>ד</div><div>ה</div><div>ו</div><div>ש</div>
      </div>
      <div class="qcMonthGrid" id="qcMonthGrid"></div>
    </div>

    <div class="qcMonthJournalMeta" id="qcMonthJournalMeta">בחרי יום כדי לכתוב הערות</div>
    <textarea class="qcMonthJournalText" id="qcMonthJournalText" placeholder="כתבי כאן הערות חופשיות..."></textarea>

    <div class="qcMonthActions">
      <button class="qcMonthBtn" id="qcMonthJournalClear" type="button">נקה</button>
      <button class="qcMonthBtn primary" id="qcMonthJournalSave" type="button">שמור</button>
    </div>
  </div>
</div>


<script>
/* --- Month button opens month calendar modal + free text notes (robust) --- */
(function(){
  const ALERT_PHRASE = 'תצוגת חודש תתווסף בשלב הבא';

  const hebMonths = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];

  // Prevent built-in alert from showing if still triggered somewhere
  const _alert = window.alert;
  window.alert = function(msg){
    try{
      if(typeof msg === 'string' && msg.includes(ALERT_PHRASE)){
        return;
      }
    }catch(e){}
    return _alert.call(window, msg);
  };

  function israelNow(){
    return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Jerusalem" }));
  }
  function isoFromParts(y,m,d){
    const mm = String(m+1).padStart(2,'0');
    const dd = String(d).padStart(2,'0');
    return `${y}-${mm}-${dd}`;
  }
  function keyFor(iso){ return `qc_month_note_${iso}`; }
  function loadFor(iso){ try{ return localStorage.getItem(keyFor(iso)) || ""; }catch(e){ return ""; } }
  function saveFor(iso, val){ try{ localStorage.setItem(keyFor(iso), val||""); }catch(e){} }
  function clearFor(iso){ try{ localStorage.removeItem(keyFor(iso)); }catch(e){} }

  let viewYear = null;
  let viewMonth = null;
  let selectedISO = null;

  function render(){
    const grid = document.getElementById('qcMonthGrid');
    const label = document.getElementById('qcMonthLabel');
    if(!grid || !label) return;

    label.textContent = hebMonths[viewMonth] + ' ' + viewYear;
    grid.innerHTML = '';

    const first = new Date(viewYear, viewMonth, 1);
    const startDow = first.getDay(); // 0 Sunday
    const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();

    // empties
    for(let i=0;i<startDow;i++){
      const e = document.createElement('div');
      e.className = 'qcDay empty';
      grid.appendChild(e);
    }

    const now = israelNow();
    const todayISO = isoFromParts(now.getFullYear(), now.getMonth(), now.getDate());

    for(let d=1; d<=daysInMonth; d++){
      const iso = isoFromParts(viewYear, viewMonth, d);

      
      let _qcHasNote = false;
      try{
        _qcHasNote = ((localStorage.getItem(keyFor(iso)) || '').trim().length > 0);
      }catch(e){}
const cell = document.createElement('div');
      cell.className = 'qcDay';
      cell.setAttribute('data-iso', iso);
      try{
        const _noteNow = (localStorage.getItem(keyFor(iso)) || '').trim();
        if(_noteNow) cell.classList.add('hasNote');
      }catch(e){}

      cell.textContent = String(d);

      if(iso === todayISO) cell.classList.add('today');
      if(iso === selectedISO) cell.classList.add('selected');

      // dot if has note
      try{
        const has = (localStorage.getItem(keyFor(iso)) || '').trim().length > 0;
        if(has){
          const dot = document.createElement('div');
          dot.className = 'qcDot';
          cell.appendChild(dot);
        }
      }catch(e){}

      cell.addEventListener('click', ()=>{
        selectedISO = iso;
        document.getElementById('qcMonthJournalMeta').textContent = 'הערות ליום: ' + iso;
        document.getElementById('qcMonthJournalText').value = loadFor(iso);
        render();
        document.getElementById('qcMonthJournalText').focus();
      });

      grid.appendChild(cell);
    }
  }

  function openModal(){
    const ov = document.getElementById('qcMonthOverlay');
    if(!ov) return;
    ov.classList.add('show');
    ov.setAttribute('aria-hidden','false');

    const now = israelNow();
    if(viewYear===null){ viewYear = now.getFullYear(); }
    if(viewMonth===null){ viewMonth = now.getMonth(); }
    if(!selectedISO){ selectedISO = isoFromParts(now.getFullYear(), now.getMonth(), now.getDate()); }

    document.getElementById('qcMonthJournalMeta').textContent = 'הערות ליום: ' + selectedISO;
    document.getElementById('qcMonthJournalText').value = loadFor(selectedISO);

    render();
    document.getElementById('qcMonthJournalText').focus();
  }

  function closeModal(){
    const ov = document.getElementById('qcMonthOverlay');
    if(!ov) return;
    ov.classList.remove('show');
    ov.setAttribute('aria-hidden','true');
  }

  function wire(){
    // modal buttons
    document.getElementById('qcMonthClose')?.addEventListener('click', closeModal);
    const ov = document.getElementById('qcMonthOverlay');
    ov?.addEventListener('click', (e)=>{ if(e.target===ov) closeModal(); });

    document.getElementById('qcPrevMonth')?.addEventListener('click', ()=>{
      viewMonth -= 1;
      if(viewMonth < 0){ viewMonth = 11; viewYear -= 1; }
      render();
    });
    document.getElementById('qcNextMonth')?.addEventListener('click', ()=>{
      viewMonth += 1;
      if(viewMonth > 11){ viewMonth = 0; viewYear += 1; }
      render();
    });

    document.getElementById('qcMonthJournalSave')?.addEventListener('click', ()=>{
      if(!selectedISO) return;
      const ta = document.getElementById('qcMonthJournalText');
      saveFor(selectedISO, ta ? ta.value : '');
      render(); // refresh dots
      closeModal();
    });
    document.getElementById('qcMonthJournalClear')?.addEventListener('click', ()=>{
      if(!selectedISO) return;
      document.getElementById('qcMonthJournalText').value = '';
      clearFor(selectedISO);
      render();
    });

    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // Robust click capture on Month button, even if app rebinds
    document.addEventListener('click', (e)=>{
      const t = e.target && e.target.closest ? e.target.closest('#btnMonthView') : null;
      if(!t) return;
      e.preventDefault();
      e.stopPropagation();
      if(e.stopImmediatePropagation) e.stopImmediatePropagation();
      // kill any inline handler
      try{ t.onclick = null; }catch(err){}
      openModal();
    }, true);

    // Also keep removing onclick for a short time (app might assign later)
    let ticks = 0;
    const killer = setInterval(()=>{
      ticks++;
      const btn = document.getElementById('btnMonthView');
      if(btn) { try{ btn.onclick = null; }catch(e){} }
      if(ticks > 80) clearInterval(killer);
    }, 100);
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', wire);
  } else {
    wire();
  }
})();
</script>


<script>
/* --- Sweep calendar to paint days with notes pink (post-render safety) --- */
(function(){
  function applyHasNote(){
    document.querySelectorAll('.qcDay').forEach(btn=>{
      const iso = btn.getAttribute('data-iso');
      if(!iso) return;
      try{
        const has = (localStorage.getItem('qc_month_note_'+iso) || '').trim().length>0;
        btn.classList.toggle('hasNote', has);
      }catch(e){}
    });
  }
  // run after any modal open or save
  document.addEventListener('qc_month_rendered', applyHasNote);
  document.addEventListener('DOMContentLoaded', applyHasNote);
  setTimeout(applyHasNote, 300);
})();
</script>


<script>
/* --- Final sweep: ensure days with saved notes are pink --- */
(function(){
  function sweep(){
    document.querySelectorAll('.qcDay[data-iso]').forEach(d=>{
      try{
        const iso = d.getAttribute('data-iso');
        const has = ((localStorage.getItem('qc_month_note_'+iso)||localStorage.getItem('qc_month_journal_'+iso)||'').trim().length>0);
        d.classList.toggle('hasNote', has);
      }catch(e){}
    });
  }
  document.addEventListener('DOMContentLoaded', sweep);
  setTimeout(sweep, 200);
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const el = document.getElementById('dailyMotivation');
  if(el){ el.textContent = 'MAKE IT DONE'; }
});
</script>


<script>
/* ===== QuietControl: Export Work + Personal tables into ONE Excel file (two sections) ===== */
(function(){
  function cellValue(td){
    if(!td) return '';
    // Inputs/selects
    const input = td.querySelector('input, select, textarea');
    if(input){
      if(input.tagName === 'SELECT'){
        const opt = input.options[input.selectedIndex];
        return (opt ? opt.textContent : '').trim();
      }
      if(input.type === 'checkbox'){
        return input.checked ? 'כן' : 'לא';
      }
      return (input.value || '').toString().trim();
    }
    // Contenteditable or plain text
    const ce = td.querySelector('[contenteditable="true"]');
    if(ce) return (ce.innerText || '').replace(/\u00A0/g,' ').trim();
    return (td.innerText || '').replace(/\u00A0/g,' ').trim();
  }

  function tableToAOA(table){
    if(!table) return [];
    const aoa = [];
    const ths = Array.from(table.querySelectorAll('thead th')).map(th => (th.innerText||'').replace(/\u00A0/g,' ').trim());
    // Drop "פעולות" column if exists
    let dropIdx = ths.findIndex(h => h.replace(/\s+/g,'') === 'פעולות');
    if(dropIdx === -1){
      // sometimes header is inside span
      dropIdx = ths.findIndex(h => h.includes('פעולות'));
    }
    const headers = ths.filter((_,i)=>i!==dropIdx);
    aoa.push(headers);

    const rows = Array.from(table.querySelectorAll('tbody tr'));
    rows.forEach(tr=>{
      const tds = Array.from(tr.children);
      const row = tds
        .map((td,i)=> (i===dropIdx ? null : cellValue(td)))
        .filter(v => v !== null);
      // keep even empty rows if there is any content
      const hasAny = row.some(v => (v||'').toString().trim().length>0);
      if(hasAny) aoa.push(row);
    });
    return aoa;
  }

  
  function rtlReverseAOA(aoa){
    // Excel may open this sheet in RTL mode for Hebrew locales.
    // Reversing columns ensures the visible order matches the on-screen table.
    return aoa.map(row => Array.isArray(row) ? row.slice().reverse() : row);
  }

function exportWorkPersonal(){
    // Export a SINGLE Excel file with ONLY the tasks text (no urgency/day/hour/actions)
    if(typeof XLSX === 'undefined' || !XLSX.utils){
      alert('יצוא לאקסל לא זמין כרגע (חסרה ספרייה). ודאי שיש אינטרנט ונסי שוב.');
      return;
    }

    const workBody = document.getElementById('brainBodyWork');
    const personalBody = document.getElementById('brainBodyPersonal');

    function extractTasks(tbody){
      const out = [];
      if(!tbody) return out;
      tbody.querySelectorAll('tr').forEach(tr=>{
        // Prefer the editable task element if present
        const taskEl = tr.querySelector('.taskText') || tr.querySelector('.taskCell') || tr.querySelector('td');
        const txt = (taskEl ? taskEl.innerText : '').replace(/\s+/g,' ').trim();
        if(txt) out.push([txt]);
      });
      return out;
    }

    const workTasks = extractTasks(workBody);
    const personalTasks = extractTasks(personalBody);

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([]);

    let r = 0;

    // Title: Work
    XLSX.utils.sheet_add_aoa(ws, [['משימות בעבודה']], {origin: {r:r, c:0}});
    r += 1;

    // Work tasks
    if(workTasks.length){
      XLSX.utils.sheet_add_aoa(ws, workTasks, {origin: {r:r, c:0}});
      r += workTasks.length;
    }else{
      XLSX.utils.sheet_add_aoa(ws, [['(אין נתונים)']], {origin: {r:r, c:0}});
      r += 1;
    }

    // Spacer
    r += 2;

    // Title: Personal
    XLSX.utils.sheet_add_aoa(ws, [['משימות אישיות']], {origin: {r:r, c:0}});
    r += 1;

    // Personal tasks
    if(personalTasks.length){
      XLSX.utils.sheet_add_aoa(ws, personalTasks, {origin: {r:r, c:0}});
      r += personalTasks.length;
    }else{
      XLSX.utils.sheet_add_aoa(ws, [['(אין נתונים)']], {origin: {r:r, c:0}});
      r += 1;
    }

    // Column width
    try{ ws['!cols'] = [{wch: 70}]; }catch(e){}

    XLSX.utils.book_append_sheet(wb, ws, 'Tasks');

    const d = new Date();
    const pad = (n)=> String(n).padStart(2,'0');
    const fn = `QuietControl_Tasks_Work_Personal_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}.xlsx`;
    XLSX.writeFile(wb, fn);
  }

  function bind(){
    document.querySelectorAll('.fmtExport').forEach(btn=>{
      // Prevent losing selection/focus issues on mousedown
      btn.addEventListener('mousedown', (e)=>{ e.preventDefault(); }, true);
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        exportWorkPersonal();
      });
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  }else{
    bind();
  }
})();
</script>

</body>
</html>
